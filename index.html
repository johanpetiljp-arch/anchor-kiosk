<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Anchor Lab & Medical Center Inc. - Queuing System</title>
    <link rel="icon" type="image/x-icon" href="logo_anchor.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', Tahoma, Geneva, sans-serif; }
        body {
            background: linear-gradient(135deg, #f0f7fd 0%, #e6f2ff 100%);
            color: #2c3e50; line-height: 1.6; min-height: 100vh; padding: 20px;
        }
        .container { 
            width: 100%; 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        header {
            background: linear-gradient(135deg, #0d4d75 0%, #1a6fa0 100%); 
            color: white; 
            padding: 25px 0;
            text-align: center; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            position:relative;
        }
        .logo-container { 
            display:flex; 
            align-items:center; 
            margin-bottom:15px;
            background: rgba(255,255,255,0.15); 
            padding:15px 25px; 
            border-radius:12px; 
            backdrop-filter: blur(10px);
        }
        .logo { 
            width:100px; 
            height:100px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            margin-right:5px; 
        }
        .logo img { 
            max-width:100%; 
            max-height:100%; 
            object-fit:contain; 
        }
        .company-name h1 { 
            font-size:28px; 
            font-weight:700; 
            letter-spacing:0.5px; 
            margin:0; 
            line-height:1.2; 
        }
        .system-title { 
            font-size:22px; 
            font-weight:400; 
            margin-top:15px; 
            color:#e6f7ff; 
            padding:12px 25px;
            background: rgba(0,0,0,0.2); 
            border-radius:8px; 
        }
        .content { 
            display:flex; 
            flex-wrap:wrap; 
        }
        .login-section { 
            flex:1; 
            min-width:400px; 
            padding:40px; 
            background:white; 
            display:flex; 
            flex-direction:column; 
            justify-content:center; 
        }
        .display-section { 
            flex:1.2; 
            min-width:400px; 
            background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); 
            padding:30px; 
            border-left:1px solid #e0e0e0; 
            display: flex;
            flex-direction: column;
        }
        .login-header { 
            text-align:center; 
            margin-bottom:35px; 
        }
        .login-logo { 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            margin-bottom:10px; 
        }
        .login-logo .logo { 
            width:150px; 
            height:150px; 
            margin-right:20px; 
        }
        .login-title { 
            font-size:25px; 
            color:#1a6fa0; 
            font-weight:600; 
            margin-bottom:5px; 
        }
        .form-group { 
            margin-bottom:20px; 
            position:relative; 
        }
        .form-group label { 
            display:block; 
            margin-bottom:10px; 
            font-weight:600; 
            color:#495057; 
            font-size:16px; 
            display:flex; 
            align-items:center; 
        }
        .form-group label i { 
            margin-right:10px; 
            color:#1a6fa0; 
        }
        .form-group input, .form-group select { 
            width:100%; 
            padding:14px 16px 14px 50px; 
            border:2px solid #dee2e6; 
            border-radius:10px; 
            font-size:16px; 
            transition:all .3s; 
        }
        .form-group i.input-icon { 
            position:absolute; 
            left:16px; 
            top:44px; 
            color:#6c757d; 
            font-size:20px; 
        }
        .form-group input:focus, .form-group select:focus { 
            border-color:#4db8ff; 
            outline:none; 
            box-shadow:0 0 0 3px rgba(77,184,255,0.2); 
        }
        button { 
            background:linear-gradient(135deg,#1a6fa0 0%,#0d4d75 100%); 
            color:white; 
            border:none; 
            padding:18px 24px; 
            border-radius:10px; 
            cursor:pointer; 
            font-size:17px; 
            width:100%; 
            transition:all .3s; 
            font-weight:600; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
        }
        button i { 
            margin-right:10px; 
        }
        button:hover { 
            transform:translateY(-3px); 
            box-shadow:0 6px 12px rgba(0,0,0,0.15); 
        }
        .main-system { 
            display:none; 
            padding:30px; 
        }
        .staff-panel, .display-panel { 
            background:white; 
            border-radius:12px; 
            box-shadow:0 5px 15px rgba(0,0,0,0.08); 
            margin-bottom:30px; 
            padding:30px; 
            overflow:hidden; 
            border:1px solid #e0e0e0; 
        }
        .panel-header { 
            display:flex; 
            align-items:center; 
            margin-bottom:25px; 
            padding-bottom:20px; 
            border-bottom:2px solid #e9ecef; 
        }
        .panel-header i { 
            font-size:24px; 
            color:#1a6fa0; 
            margin-right:12px; 
            background:#e6f7ff; 
            padding:12px; 
            border-radius:10px; 
        }
        .panel-header h2 { 
            color:#1a6fa0; 
            font-size:24px; 
            margin:0; 
        }
        .service-buttons { 
            display:grid; 
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); 
            gap:16px; 
            margin-bottom:30px; 
        }
        .service-btn { 
            background:linear-gradient(135deg,#e6f7ff 0%,#cce5ff 100%); 
            color:#1a6fa0; 
            border:2px solid #4db8ff; 
            padding:18px; 
            border-radius:10px; 
            cursor:pointer; 
            text-align:center; 
            transition:all .3s; 
            font-weight:600; 
            font-size:16px; 
            box-shadow:0 4px 8px rgba(0,0,0,0.05); 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
        }
        .service-btn i { 
            font-size:24px; 
            margin-bottom:10px; 
            color:#1a6fa0; 
        }
        .service-btn:hover, .service-btn.active { 
            background:linear-gradient(135deg,#4db8ff 0%,#1a6fa0 100%); 
            color:white; 
            transform:translateY(-3px); 
            box-shadow:0 6px 12px rgba(77,184,255,0.3); 
        }
        .service-btn:hover i, .service-btn.active i { 
            color:white; 
        }
        .queue-controls { 
            display:flex; 
            justify-content:space-between; 
            margin-top:30px; 
            gap:18px; 
        }
        .control-btn { 
            width:48%; 
        }
        .start-btn { 
            background:linear-gradient(135deg,#28a745 0%,#1e7e34 100%); 
        }
        .next-btn { 
            background:linear-gradient(135deg,#ff9800 0%,#e65100 100%); 
        }
        .ticket-preview { 
            background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); 
            border:2px dashed #4db8ff; 
            padding:30px; 
            margin-top:30px; 
            text-align:center; 
            border-radius:12px; 
            transition:all .3s; 
            position:relative; 
            cursor:pointer; 
        }
        .ticket-header { 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            margin-bottom:20px; 
        }
        .ticket-logo { 
            width:100px; 
            height:100px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            margin-right:12px; 
        }
        .ticket-logo img { 
            max-width:100%; 
            max-height:100%; 
            object-fit:contain; 
        }
        .ticket-title { 
            font-size:20px; 
            font-weight:700; 
            color:#1a6fa0; 
        }
        .ticket-number { 
            font-size:52px; 
            font-weight:800; 
            color:#e53935; 
            margin:20px 0; 
            text-shadow:2px 2px 4px rgba(0,0,0,0.1); 
        }
        .ticket-service { 
            font-size:22px; 
            color:#6c757d; 
            font-weight:500; 
            margin-bottom:15px; 
        }
        .ticket-patient { 
            font-size:16px; 
            color:#495057; 
            font-weight:500; 
        }
        .ticket-preview.printing { 
            transform:scale(1.02); 
            box-shadow:0 12px 24px rgba(0,0,0,0.15); 
        }
        .display-screen { 
            background:linear-gradient(135deg,#1a6fa0 0%,#0d4d75 100%); 
            color:white; 
            padding:40px; 
            border-radius:12px; 
            text-align:center; 
            margin-bottom:30px; 
            box-shadow:0 12px 24px rgba(0,0,0,0.2); 
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .display-header { 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            margin-bottom:25px; 
        }
        .display-logo { 
            display:flex; 
            align-items:center; 
            margin-bottom:15px; 
        }
        .display-title { 
            font-size:28px; 
            font-weight:700; 
            color:#ffcb05; 
        }
        .current-number { 
            font-size:90px; 
            font-weight:800; 
            color:#ffcb05; 
            margin:30px 0; 
            text-shadow:3px 3px 6px rgba(0,0,0,0.3); 
        }
        .current-service { 
            font-size:30px; 
            color:#e6f7ff; 
            margin-bottom: 10px;
        }
        .current-patient {
            font-size: 24px;
            color: #e6f7ff;
        }
        .queue-list { 
            list-style:none; 
            margin-top:30px; 
            max-height:400px; 
            overflow-y:auto; 
            flex-grow: 1;
        }
        .queue-item { 
            background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); 
            padding:20px; 
            margin-bottom:15px; 
            border-radius:10px; 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            box-shadow:0 4px 8px rgba(0,0,0,0.08); 
            transition:all .3s; 
            border-left:5px solid #4db8ff; 
        }
        .queue-item .left { 
            display:flex; 
            align-items:center; 
            gap:12px; 
        }
        .queue-number { 
            font-weight:800; 
            font-size:20px; 
            color:#1a6fa0; 
            margin-right:12px; 
        }
        .queue-service { 
            color:#6c757d; 
            font-weight:500; 
            font-size:16px; 
        }
        .queue-patient { 
            color:#495057; 
            font-size:14px; 
            margin-left:10px; 
            font-weight:500; 
        }
        .now-serving { 
            background:linear-gradient(135deg,#fff8e1 0%,#ffecb3 100%); 
            border-left:5px solid #ff9800; 
        }
        .logout-btn { 
            background:linear-gradient(135deg,#e53935 0%,#b71c1c 100%); 
            max-width:220px; 
            margin:30px auto; 
            display:block; 
        }
        .notification { 
            position:fixed; 
            top:30px; 
            right:30px; 
            padding:18px 24px; 
            border-radius:10px; 
            background:linear-gradient(135deg,#28a745 0%,#1e7e34 100%); 
            color:white; 
            box-shadow:0 8px 16px rgba(0,0,0,0.2); 
            transform:translateX(100%); 
            transition:transform .3s ease-out; 
            z-index:1000; 
            font-weight:500; 
            display:flex; 
            align-items:center; 
        }
        .notification i { 
            margin-right:12px; 
            font-size:20px; 
        }
        .notification.error { 
            background:linear-gradient(135deg,#e53935 0%,#b71c1c 100%); 
        }
        .notification.show { 
            transform:translateX(0); 
        }
        .instructions { 
            background:linear-gradient(135deg,#e6f7ff 0%,#cce5ff 100%); 
            padding:20px; 
            border-radius:10px; 
            margin-bottom:25px; 
            border-left:5px solid #4db8ff; 
        }
        .instructions h3 { 
            color:#1a6fa0; 
            margin-bottom:15px; 
            display:flex; 
            align-items:center; 
        }
        .instructions h3 i { 
            margin-right:10px; 
        }
        .instructions ol { 
            padding-left:30px; 
        }
        .instructions li { 
            margin-bottom:12px; 
            color:#495057; 
        }
        .patient-info { 
            display:flex; 
            gap:12px; 
            margin-bottom:16px; 
            flex-wrap:wrap; 
        }
        .patient-info .form-group { 
            flex:1 1 220px; 
            margin-bottom:0; 
        }
        
        /* Daily Stats Panel */
        .daily-stats { 
            background:linear-gradient(135deg,#e6f7ff 0%,#cce5ff 100%); 
            padding:20px; 
            border-radius:10px; 
            margin-bottom:25px; 
            border-left:5px solid #4db8ff; 
        }
        .daily-stats h3 { 
            color:#1a6fa0; 
            margin-bottom:15px; 
            display:flex; 
            align-items:center; 
        }
        .daily-stats h3 i { 
            margin-right:10px; 
        }
        .stats-grid { 
            display:grid; 
            grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); 
            gap:15px; 
            margin-top:15px; 
        }
        .stat-item { 
            background:white; 
            padding:15px; 
            border-radius:8px; 
            text-align:center; 
            box-shadow:0 2px 5px rgba(0,0,0,0.1); 
        }
        .stat-value { 
            font-size:24px; 
            font-weight:700; 
            color:#1a6fa0; 
            margin-bottom:5px; 
        }
        .stat-label { 
            font-size:14px; 
            color:#6c757d; 
        }
        
        /* Demographics Section */
        .demographics-section { 
            display: none; 
            margin-top: 30px; 
        }
        .demographics-btn { 
            background:linear-gradient(135deg,#9c27b0 0%,#6a1b9a 100%); 
            max-width: 280px; 
            margin: 20px 0; 
        }
        .demographics-panel { 
            background:white; 
            border-radius:12px; 
            box-shadow:0 5px 15px rgba(0,0,0,0.08); 
            margin-bottom:30px; 
            padding:30px; 
            overflow:hidden; 
            border:1px solid #e0e0e0; 
        }
        .demographics-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        .demographics-table th, .demographics-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #e0e0e0; 
        }
        .demographics-table th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            color: #1a6fa0; 
        }
        .demographics-table tr:hover { 
            background-color: #f5f5f5; 
        }
        .demographics-actions { 
            display: flex; 
            gap: 15px; 
            margin-top: 20px; 
            flex-wrap: wrap; 
        }
        .print-demographics-btn { 
            background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%); 
            max-width: 200px; 
        }
        .download-demographics-btn { 
            background:linear-gradient(135deg,#2196f3 0%,#0d47a1 100%); 
            max-width: 200px; 
        }
        .close-demographics-btn { 
            background:linear-gradient(135deg,#607d8b 0%,#37474f 100%); 
            max-width: 200px; 
        }
        
        /* NEW: Service-specific next buttons */
        .next-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }
        .next-service-btn {
            background: linear-gradient(135deg, #ff9800 0%, #e65100 100%);
            padding: 12px 16px;
            font-size: 14px;
        }
        
        /* NEW: Recently called patients section */
        .recently-called-section {
            margin-top: 30px;
            display: block; /* Always visible */
        }
        .recently-called-list {
            list-style: none;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .recently-called-item {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #4caf50;
        }
        .recently-called-item .left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .recently-called-number {
            font-weight: 700;
            font-size: 18px;
            color: #2e7d32;
            margin-right: 10px;
        }
        .recently-called-service {
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        .recently-called-name {
            color: #333;
            font-size: 13px;
            margin-left: 8px;
            font-weight: 500;
        }
        .recently-called-time {
            color: #777;
            font-size: 12px;
            font-style: italic;
        }
        
        @media (max-width:900px) { 
            .content { 
                flex-direction:column; 
            } 
            .display-section { 
                border-left:none; 
                border-top:1px solid #e0e0e0; 
            } 
        }
        
        /* ROLL PAPER PRINTING STYLES - UPDATED FOR ROLL PAPER QUEUE TICKETS */
        @media print { 
            body * { 
                visibility:hidden; 
            } 
            .ticket-preview, .ticket-preview * { 
                visibility:visible; 
            } 
            .ticket-preview { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 80mm !important; /* Standard receipt paper width */
                min-height: 120mm !important; /* Increased height for queue ticket */
                border: none !important; 
                box-shadow: none !important;
                margin: 0 !important;
                padding: 5mm !important;
                background: white !important;
                font-size: 12px !important;
                transform: scale(1) !important;
                font-family: 'Courier New', monospace !important; /* Better for thermal printers */
            }
            .ticket-header {
                flex-direction: column !important;
                text-align: center !important;
                margin-bottom: 8px !important;
            }
            .ticket-logo {
                width: 50px !important; /* Smaller logo for roll paper */
                height: 50px !important;
                margin: 0 auto 5px !important;
            }
            .ticket-title {
                font-size: 14px !important;
                font-weight: bold !important;
                line-height: 1.2 !important;
                margin-bottom: 5px !important;
            }
            .ticket-preview h3 {
                font-size: 13px !important;
                margin: 5px 0 !important;
                border-bottom: 1px dashed #000 !important;
                padding-bottom: 5px !important;
            }
            .ticket-number {
                font-size: 42px !important; /* Larger number for queue ticket */
                margin: 15px 0 !important;
                font-weight: bold !important;
                color: #000 !important; /* Black for better thermal printing */
            }
            .ticket-service {
                font-size: 18px !important;
                margin-bottom: 8px !important;
                font-weight: bold !important;
            }
            .ticket-patient {
                font-size: 12px !important;
                margin-bottom: 5px !important;
            }
            
            /* Add barcode area for queue systems */
            .barcode-area {
                margin: 10px 0 !important;
                text-align: center !important;
                border-top: 1px dashed #000 !important;
                padding-top: 10px !important;
            }
            .barcode-placeholder {
                height: 40px !important;
                border: 1px solid #ccc !important;
                margin: 5px auto !important;
                width: 80% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 10px !important;
                color: #666 !important;
            }
            
            /* Footer with date and time */
            .ticket-footer {
                font-size: 10px !important;
                text-align: center !important;
                margin-top: 10px !important;
                border-top: 1px dashed #000 !important;
                padding-top: 8px !important;
            }
            
            /* Hide demographics panel when printing ticket */
            .demographics-panel, .demographics-panel * { 
                visibility: hidden !important; 
                display: none !important;
            }
            
            /* Hide any buttons or controls */
            button, .service-btn, .queue-controls, .instructions, .patient-info {
                display: none !important;
            }
        }
        
        /* FIX: Improved display layout to prevent cut-off */
        .display-section h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #1a6fa0;
        }
        
        /* FIX: Ensure display screen fits properly */
        .display-screen .display-header {
            margin-bottom: 10px;
        }
        
        /* FIX: Adjust display for smaller screens */
        @media (max-width: 768px) {
            .display-screen {
                padding: 20px;
            }
            .current-number {
                font-size: 60px;
            }
            .current-service, .current-patient {
                font-size: 20px;
            }
        }
        
        /* Connection status indicator */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .connection-status.connected {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }
        .connection-status.disconnected {
            background: linear-gradient(135deg, #e53935 0%, #b71c1c 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo">
                    <img src="logo_anchor.png" alt="Anchor Lab & Medical Center Inc. Logo">
                </div>
                <div class="company-name">
                    <h1>ANCHOR LAB & MEDICAL CENTER INC.</h1>
                </div>
            </div>
            <div class="system-title">Patient Queuing System</div>
        </header>

        <div class="content">
            <section class="login-section" id="loginSection">
                <div class="login-header">
                    <div class="login-logo">
                        <div class="logo">
                            <img src="logo_anchor.png" alt="Anchor Lab & Medical Center Inc. Logo">
                        </div>
                        <div>
                            <div class="login-title">ANCHOR LAB &</div>
                            <div class="login-title">MEDICAL CENTER INC.</div>
                        </div>
                    </div>
                    <h2>Staff Login Portal</h2>
                </div>
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" placeholder="Enter your username">
                    <i class="fas fa-user input-icon"></i>
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" placeholder="Enter your password">
                    <i class="fas fa-lock input-icon"></i>
                </div>
                <button id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login to System</button>
            </section>

            <section class="display-section">
                <div class="display-screen">
                    <div class="display-header">
                        <div class="display-logo">
                            <div class="logo">
                                <img src="logo_anchor.png" alt="Logo">
                            </div>
                            <div class="display-title">ANCHOR LAB & MEDICAL CENTER INC.</div>
                        </div>
                    </div>
                    <h3>Now Serving</h3>
                    <div class="current-number" id="publicCurrentNumber">--</div>
                    <div class="current-service" id="publicCurrentService">Please wait for your number</div>
                    <div class="current-patient" id="publicCurrentPatient"></div>
                </div>
                
                <!-- NEW: Recently Called Patients Section -->
                <div class="recently-called-section">
                    <h3><i class="fas fa-history"></i> Recently Called Patients</h3>
                    <ul class="recently-called-list" id="recentlyCalledList">
                        <li class="recently-called-item">No patients called yet</li>
                    </ul>
                </div>

                <h3><i class="fas fa-clock"></i> Waiting Queue</h3>
                <ul class="queue-list" id="publicQueueList">
                    <li class="queue-item">No patients in queue</li>
                </ul>
            </section>
        </div>

        <section class="main-system" id="mainSystem">
            <div class="staff-panel">
                <div class="panel-header">
                    <i class="fas fa-user-md"></i>
                    <h2>Staff Control Panel</h2>
                </div>

                <!-- Daily Stats Panel -->
                <div class="daily-stats">
                    <h3><i class="fas fa-chart-line"></i> Today's Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="todayPatientCount">0</div>
                            <div class="stat-label">Patients Today</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="todayServicesCount">0</div>
                            <div class="stat-label">Services Today</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="servedTodayCount">0</div>
                            <div class="stat-label">Served Today</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="waitingCount">0</div>
                            <div class="stat-label">Waiting Now</div>
                        </div>
                    </div>
                </div>

                <div class="instructions">
                    <h3><i class="fas fa-info-circle"></i> How to Use the System:</h3>
                    <ol>
                        <li>Enter patient Name, Age and Gender first.</li>
                        <li>Select a medical service (this requires patient details).</li>
                        <li>Click the ticket preview to print and add the patient to the queue.</li>
                        <li>Click "Next Patient" for the specific service when ready to call the next person.</li>
                    </ol>
                </div>

                <!-- Patient info area -->
                <div class="patient-info">
                    <div class="form-group">
                        <label for="patientName"><i class="fas fa-id-card"></i> Patient Name</label>
                        <input type="text" id="patientName" placeholder="Full name">
                        <i class="fas fa-id-card input-icon"></i>
                    </div>
                    <div class="form-group">
                        <label for="patientAge"><i class="fas fa-birthday-cake"></i> Age</label>
                        <input type="number" id="patientAge" placeholder="Age" min="0">
                        <i class="fas fa-birthday-cake input-icon"></i>
                    </div>
                    <div class="form-group">
                        <label for="patientGender"><i class="fas fa-venus-mars"></i> Gender</label>
                        <select id="patientGender">
                            <option value="">Select gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        <i class="fas fa-venus-mars input-icon"></i>
                    </div>
                </div>

                <div class="service-buttons">
                    <div class="service-btn" data-service="2D Echo"><i class="fas fa-heart"></i> 2D Echo</div>
                    <div class="service-btn" data-service="X-Ray"><i class="fas fa-x-ray"></i> X-Ray</div>
                    <div class="service-btn" data-service="Drug Test"><i class="fas fa-pills"></i> Drug Test</div>
                    <div class="service-btn" data-service="Ultrasound"><i class="fas fa-baby"></i> Ultrasound</div>
                    <div class="service-btn" data-service="Blood Test"><i class="fas fa-tint"></i> Blood Test</div>
                    <div class="service-btn" data-service="ECG"><i class="fas fa-heartbeat"></i> ECG</div>
                    <div class="service-btn" data-service="Dental"><i class="fas fa-tooth"></i> Dental</div>
                    <div class="service-btn" data-service="CBC"><i class="fas fa-vial"></i> CBC</div>
                </div>

                <div class="ticket-preview" id="ticketPreview" title="Click to print/add ticket">
                    <div class="ticket-header">
                        <div class="ticket-logo">
                            <img src="logo_anchor.png" alt="Logo">
                        </div>
                        <div class="ticket-title">ANCHOR LAB & MEDICAL CENTER INC.</div>
                    </div>
                    <h3>Patient Queue Ticket</h3>
                    <div class="ticket-number" id="ticketNumber">--</div>
                    <div class="ticket-service" id="ticketService">Please select a service</div>
                    <div class="ticket-patient" id="ticketPatient">Patient: —</div>
                </div>

                <div class="queue-controls">
                    <button class="control-btn start-btn" id="startQueueBtn"><i class="fas fa-play-circle"></i> Start Queue</button>
                    <!-- Single Next button removed - now using service-specific buttons -->
                </div>
                
                <!-- NEW: Service-specific Next buttons -->
                <div class="next-buttons-grid" id="nextButtonsGrid">
                    <!-- Buttons will be generated dynamically -->
                </div>

                <button class="demographics-btn" id="demographicsBtn"><i class="fas fa-chart-bar"></i> View Demographics</button>

                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>

            <div class="display-panel">
                <div class="panel-header">
                    <i class="fas fa-tv"></i>
                    <h2>Patient Display Screen</h2>
                </div>

                <div class="display-screen">
                    <div class="display-header">
                        <div class="display-logo">
                            <div class="logo">
                                <img src="logo_anchor.png" alt="Logo">
                            </div>
                            <div class="display-title">ANCHOR LAB & MEDICAL CENTER INC.</div>
                        </div>
                    </div>
                    <h3>Now Serving</h3>
                    <div class="current-number" id="currentNumber">--</div>
                    <div class="current-service" id="currentService">Please wait for your number</div>
                    <div class="current-patient" id="currentPatient"></div>
                </div>
                
                <!-- NEW: Recently Called Patients Section in Staff Panel -->
                <div class="recently-called-section">
                    <h3><i class="fas fa-history"></i> Recently Called Patients</h3>
                    <ul class="recently-called-list" id="staffRecentlyCalledList">
                        <li class="recently-called-item">No patients called yet</li>
                    </ul>
                </div>

                <h3><i class="fas fa-clock"></i> Waiting Queue</h3>
                <ul class="queue-list" id="queueListDisplay">
                    <li class="queue-item">No patients in queue</li>
                </ul>
            </div>

            <!-- Demographics Section -->
            <div class="demographics-section" id="demographicsSection">
                <div class="demographics-panel">
                    <div class="panel-header">
                        <i class="fas fa-chart-bar"></i>
                        <h2>Patient Demographics</h2>
                    </div>
                    
                    <p>This section shows demographic data of patients who have used the queuing system.</p>
                    
                    <table class="demographics-table" id="demographicsTable">
                        <thead>
                            <tr>
                                <th>Ticket No.</th>
                                <th>Patient Name</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="demographicsTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                    
                    <div class="demographics-actions">
                        <button class="print-demographics-btn" id="printDemographicsBtn">
                            <i class="fas fa-print"></i> Print Demographics
                        </button>
                        <button class="download-demographics-btn" id="downloadDemographicsBtn">
                            <i class="fas fa-download"></i> Download Data
                        </button>
                        <button class="close-demographics-btn" id="closeDemographicsBtn">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <div class="footer">
            <p>© 2025 Anchor Lab & Medical Center Inc. - Patient Queuing v1.0</p>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span>Patient added to queue successfully!</span>
    </div>

    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i>
        <span>Connecting...</span>
    </div>

    <script>
        // Firebase Configuration - YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAXYZqlx4vGtcifEWvFqOVFrrZUBkFoXEs",
            authDomain: "anchor-lab-queue.firebaseapp.com",
            databaseURL: "https://anchor-lab-queue-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "anchor-lab-queue",
            storageBucket: "anchor-lab-queue.firebasestorage.app",
            messagingSenderId: "817997274125",
            appId: "1:817997274125:web:148493e8972c42c4a80944",
            measurementId: "G-BV8C2KTS8V"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const loginSection = document.getElementById('loginSection');
            const mainSystem = document.getElementById('mainSystem');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const serviceButtons = document.querySelectorAll('.service-btn');
            const ticketNumber = document.getElementById('ticketNumber');
            const ticketService = document.getElementById('ticketService');
            const ticketPreview = document.getElementById('ticketPreview');
            const startQueueBtn = document.getElementById('startQueueBtn');
            const nextButtonsGrid = document.getElementById('nextButtonsGrid');
            const currentNumber = document.getElementById('currentNumber');
            const currentService = document.getElementById('currentService');
            const currentPatient = document.getElementById('currentPatient');
            const queueList = document.getElementById('queueListDisplay');
            const logoutBtn = document.getElementById('logoutBtn');
            const notification = document.getElementById('notification');
            const connectionStatus = document.getElementById('connectionStatus');
            
            // Public display elements
            const publicCurrentNumber = document.getElementById('publicCurrentNumber');
            const publicCurrentService = document.getElementById('publicCurrentService');
            const publicCurrentPatient = document.getElementById('publicCurrentPatient');
            const publicQueueList = document.getElementById('publicQueueList');
            
            // NEW: Recently called patients lists
            const recentlyCalledList = document.getElementById('recentlyCalledList');
            const staffRecentlyCalledList = document.getElementById('staffRecentlyCalledList');
            
            // Daily Stats elements
            const todayPatientCount = document.getElementById('todayPatientCount');
            const todayServicesCount = document.getElementById('todayServicesCount');
            const servedTodayCount = document.getElementById('servedTodayCount');
            const waitingCount = document.getElementById('waitingCount');
            
            // Demographics elements
            const demographicsBtn = document.getElementById('demographicsBtn');
            const demographicsSection = document.getElementById('demographicsSection');
            const demographicsTableBody = document.getElementById('demographicsTableBody');
            const printDemographicsBtn = document.getElementById('printDemographicsBtn');
            const downloadDemographicsBtn = document.getElementById('downloadDemographicsBtn');
            const closeDemographicsBtn = document.getElementById('closeDemographicsBtn');

            // Patient fields
            const patientNameInput = document.getElementById('patientName');
            const patientAgeInput = document.getElementById('patientAge');
            const patientGenderSelect = document.getElementById('patientGender');
            const ticketPatient = document.getElementById('ticketPatient');

            // System State - UPDATED: Now with service-specific numbering
            let isQueueStarted = false;
            let queues = {}; // Now an object with service names as keys
            let allPatients = []; // All historical patients
            let todayPatients = []; // Patients for today only
            let lastIssuedNumbers = {}; // Track last number for each service
            let selectedService = null;
            let lastService = null;
            let currentDisplayPatient = null; // UPDATED: Track the patient to display in the main screen
            let recentlyCalledPatients = []; // Track recently called patients
            let currentDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format

            // Initialize service-specific data
            const services = ["2D Echo", "X-Ray", "Drug Test", "Ultrasound", "Blood Test", "ECG", "Dental", "CBC"];
            
            // Initialize queues and numbering for each service
            services.forEach(service => {
                queues[service] = [];
                lastIssuedNumbers[service] = 0;
            });

            // Staff credentials
            const staffCredentials = [
                { username: 'staff1', password: 'pass1' },
                { username: 'staff2', password: 'pass2' },
                { username: 'admin', password: 'admin123' }
            ];

            // Room mapping for services
            const serviceRooms = {
                "2D Echo": "Room 1",
                "X-Ray": "Room 2",
                "Drug Test": "Room 3",
                "Ultrasound": "Room 4",
                "Blood Test": "Room 5",
                "ECG": "Room 6",
                "Dental": "Room 3",
                "CBC": "Room 5"
            };

            // Firebase Realtime Database Reference
            const queueRef = database.ref('queue');
            const systemRef = database.ref('system');

            // NEW: Create service-specific Next buttons
            function createNextButtons() {
                nextButtonsGrid.innerHTML = '';
                services.forEach(service => {
                    const button = document.createElement('button');
                    button.className = 'next-service-btn';
                    button.setAttribute('data-service', service);
                    button.innerHTML = `<i class="fas fa-forward"></i> Next ${service}`;
                    nextButtonsGrid.appendChild(button);
                    
                    // Add event listener for this button
                    button.addEventListener('click', function() {
                        callNextPatient(service);
                    });
                });
            }

            // NEW: Call next patient for a specific service
            function callNextPatient(service) {
                if (queues[service].length === 0) {
                    showNotification(`No patients in the ${service} queue`, true);
                    return;
                }

                // Remove from queue
                const nextPatient = queues[service].shift();
                
                // UPDATED: Set this patient as the current display patient
                currentDisplayPatient = nextPatient;
                
                // Update patient status to 'Served' in allPatients and todayPatients
                const patientIndex = allPatients.findIndex(p => p.number === nextPatient.number && p.service === service);
                if (patientIndex !== -1) {
                    allPatients[patientIndex].status = 'Served';
                }
                
                const todayPatientIndex = todayPatients.findIndex(p => p.number === nextPatient.number && p.service === service);
                if (todayPatientIndex !== -1) {
                    todayPatients[todayPatientIndex].status = 'Served';
                }

                // NEW: Add to recently called patients list
                const calledPatient = {
                    ...nextPatient,
                    calledTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                };
                recentlyCalledPatients.unshift(calledPatient);
                
                // Keep only the last 10 called patients
                if (recentlyCalledPatients.length > 10) {
                    recentlyCalledPatients.pop();
                }
                
                // Update the recently called patients display
                updateRecentlyCalledDisplay();

                // Save to Firebase (this will trigger real-time updates on all devices)
                saveToFirebase();

                showNotification(`Now serving ${service} patient: ${nextPatient.number}`);

                // Voice announcement with room number
                const spokenNumber = parseInt(nextPatient.number, 10) || nextPatient.number;
                const room = serviceRooms[service] || "Room 1";
                announce(`Patient number ${spokenNumber} for ${service}, please proceed to ${room}. Thank you`);
                
                // Update the main display with the called patient
                updateAllDisplays();
            }

            // NEW: Update recently called patients display
            function updateRecentlyCalledDisplay() {
                // Update public recently called list
                updateRecentlyCalledList(recentlyCalledList);
                
                // Update staff recently called list
                updateRecentlyCalledList(staffRecentlyCalledList);
            }

            // NEW: Update individual recently called list
            function updateRecentlyCalledList(listElement) {
                if (recentlyCalledPatients.length === 0) {
                    listElement.innerHTML = '<li class="recently-called-item">No patients called yet</li>';
                    return;
                }

                listElement.innerHTML = '';
                
                recentlyCalledPatients.forEach(patient => {
                    const li = document.createElement('li');
                    li.className = 'recently-called-item';
                    const left = document.createElement('div');
                    left.className = 'left';
                    const num = document.createElement('div');
                    num.className = 'recently-called-number';
                    num.textContent = patient.number;
                    const svc = document.createElement('div');
                    svc.className = 'recently-called-service';
                    svc.textContent = patient.service;
                    const pat = document.createElement('div');
                    pat.className = 'recently-called-name';
                    pat.textContent = `${patient.name} • ${patient.age} yrs • ${patient.gender}`;
                    const time = document.createElement('div');
                    time.className = 'recently-called-time';
                    time.textContent = patient.calledTime || '';
                    
                    left.appendChild(num);
                    left.appendChild(svc);
                    left.appendChild(pat);
                    
                    li.appendChild(left);
                    li.appendChild(time);
                    
                    listElement.appendChild(li);
                });
            }

            // NEW: Check and reset daily numbering for all services
            function checkAndResetDailyNumbering() {
                const today = new Date().toISOString().split('T')[0];
                
                // Check if we already have data for today
                systemRef.child('currentDate').once('value').then((snapshot) => {
                    const storedDate = snapshot.val();
                    
                    if (storedDate !== today) {
                        // It's a new day! Reset the numbering for all services
                        console.log('New day detected! Resetting numbering for all services...');
                        
                        services.forEach(service => {
                            queues[service] = [];
                            lastIssuedNumbers[service] = 0;
                        });
                        
                        todayPatients = [];
                        recentlyCalledPatients = []; // NEW: Reset recently called patients
                        currentDisplayPatient = null; // UPDATED: Reset current display patient
                        isQueueStarted = false;
                        
                        // Update Firebase with new date and reset data
                        systemRef.set({
                            currentDate: today,
                            lastIssuedNumbers: lastIssuedNumbers
                        });
                        
                        // Also update the queue data
                        saveToFirebase();
                        
                        showNotification('New day started! Numbering reset for all services.');
                    } else {
                        // Load the last issued numbers for today
                        systemRef.child('lastIssuedNumbers').once('value').then((numSnapshot) => {
                            const storedNumbers = numSnapshot.val();
                            if (storedNumbers) {
                                lastIssuedNumbers = storedNumbers;
                            }
                            updateTicketPreview();
                        });
                    }
                });
            }

            // Test Firebase connection
            function testFirebaseConnection() {
                console.log('Testing Firebase connection...');
                
                const testRef = database.ref('connectionTest');
                const testData = {
                    test: 'connection',
                    timestamp: Date.now(),
                    message: 'Testing if Firebase is working'
                };
                
                testRef.set(testData)
                    .then(() => {
                        console.log('✓ Firebase connection test: SUCCESS');
                        showNotification('Firebase connection successful!', false);
                        
                        // Clean up test data
                        setTimeout(() => {
                            testRef.remove();
                        }, 2000);
                    })
                    .catch((error) => {
                        console.error('✗ Firebase connection test: FAILED', error);
                        showNotification('Firebase connection failed: ' + error.message, true);
                    });
            }

            // Improved saveToFirebase function with service-specific data
            function saveToFirebase() {
                const dataToSave = {
                    queues: queues,
                    allPatients: allPatients,
                    todayPatients: todayPatients,
                    lastIssuedNumbers: lastIssuedNumbers,
                    isQueueStarted: isQueueStarted,
                    currentDisplayPatient: currentDisplayPatient, // UPDATED: Save current display patient
                    recentlyCalledPatients: recentlyCalledPatients, // Save recently called patients
                    timestamp: new Date().toISOString()
                };
                
                console.log('Saving to Firebase:', dataToSave);
                
                queueRef.set(dataToSave)
                    .then(() => {
                        console.log('✓ Data saved to Firebase successfully');
                        
                        // Also save the current lastIssuedNumbers to system node
                        systemRef.child('lastIssuedNumbers').set(lastIssuedNumbers);
                    })
                    .catch((error) => {
                        console.error('✗ Error saving to Firebase:', error);
                        showNotification('Error saving data to cloud: ' + error.message, true);
                    });
            }

            // Firebase Connection Status
            database.ref('.info/connected').on('value', function(snap) {
                if (snap.val() === true) {
                    connectionStatus.innerHTML = '<i class="fas fa-wifi"></i><span>Connected to Cloud</span>';
                    connectionStatus.className = 'connection-status connected';
                } else {
                    connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline - Cloud Disconnected</span>';
                    connectionStatus.className = 'connection-status disconnected';
                }
            });

            // Listen for real-time queue updates from Firebase
            queueRef.on('value', function(snapshot) {
                const data = snapshot.val();
                console.log('Firebase data received:', data);
                
                if (data) {
                    queues = data.queues || {};
                    allPatients = data.allPatients || [];
                    todayPatients = data.todayPatients || [];
                    lastIssuedNumbers = data.lastIssuedNumbers || {};
                    isQueueStarted = data.isQueueStarted || false;
                    currentDisplayPatient = data.currentDisplayPatient || null; // UPDATED: Load current display patient
                    recentlyCalledPatients = data.recentlyCalledPatients || []; // Load recently called patients
                    
                    // Initialize any missing services
                    services.forEach(service => {
                        if (!queues[service]) queues[service] = [];
                        if (!lastIssuedNumbers[service]) lastIssuedNumbers[service] = 0;
                    });
                    
                    // Update ALL displays
                    updateAllDisplays();
                    updateTicketPreview();
                    updateDailyStats();
                    updateRecentlyCalledDisplay(); // NEW: Update recently called display
                    
                    // Update staff panel if logged in
                    if (mainSystem.style.display === 'block') {
                        updateQueueControls();
                    }
                }
            });

            // NEW: Update daily statistics with service-specific data
            function updateDailyStats() {
                // Count patients for today
                todayPatientCount.textContent = todayPatients.length;
                
                // Count unique services for today
                const todayServices = new Set(todayPatients.map(p => p.service));
                todayServicesCount.textContent = todayServices.size;
                
                // Count served patients for today
                const servedToday = todayPatients.filter(p => p.status === 'Served').length;
                servedTodayCount.textContent = servedToday;
                
                // Count waiting patients across all services
                let totalWaiting = 0;
                services.forEach(service => {
                    totalWaiting += queues[service].length;
                });
                waitingCount.textContent = totalWaiting;
            }

            // Update ALL displays at once
            function updateAllDisplays() {
                updatePublicDisplay();
                updateStaffDisplay();
                updateQueueLists();
            }

            // UPDATED: Update public display - NOW SHOWS THE CURRENT DISPLAY PATIENT
            function updatePublicDisplay() {
                if (currentDisplayPatient) {
                    publicCurrentNumber.textContent = currentDisplayPatient.number;
                    publicCurrentService.textContent = currentDisplayPatient.service;
                    publicCurrentPatient.textContent = `${currentDisplayPatient.name} • ${currentDisplayPatient.age} yrs • ${currentDisplayPatient.gender}`;
                } else {
                    publicCurrentNumber.textContent = '--';
                    publicCurrentService.textContent = 'Please wait for your number';
                    publicCurrentPatient.textContent = '';
                }
            }

            // UPDATED: Update staff display - NOW SHOWS THE CURRENT DISPLAY PATIENT
            function updateStaffDisplay() {
                if (currentDisplayPatient) {
                    currentNumber.textContent = currentDisplayPatient.number;
                    currentService.textContent = currentDisplayPatient.service;
                    currentPatient.textContent = `${currentDisplayPatient.name} • ${currentDisplayPatient.age} yrs • ${currentDisplayPatient.gender}`;
                } else {
                    currentNumber.textContent = '--';
                    currentService.textContent = 'No patients in queue';
                    currentPatient.textContent = '';
                }
            }

            // Update queue lists - NOW COMBINES ALL SERVICES
            function updateQueueLists() {
                // Update public queue list
                updateQueueList(publicQueueList);
                // Update staff queue list
                updateQueueList(queueList);
            }

            // Update individual queue list - NOW COMBINES ALL SERVICES
            function updateQueueList(queueListElement) {
                // Combine all queues
                let allQueues = [];
                services.forEach(service => {
                    queues[service].forEach(patient => {
                        allQueues.push(patient);
                    });
                });
                
                // Sort by service and then by number
                allQueues.sort((a, b) => {
                    if (a.service === b.service) {
                        return parseInt(a.number) - parseInt(b.number);
                    }
                    return a.service.localeCompare(b.service);
                });

                if (allQueues.length === 0) {
                    queueListElement.innerHTML = '<li class="queue-item">No patients in queue</li>';
                    return;
                }

                queueListElement.innerHTML = '';
                
                allQueues.forEach(patient => {
                    const li = document.createElement('li');
                    li.className = 'queue-item';
                    const left = document.createElement('div');
                    left.className = 'left';
                    const num = document.createElement('div');
                    num.className = 'queue-number';
                    num.textContent = patient.number;
                    const svc = document.createElement('div');
                    svc.className = 'queue-service';
                    svc.textContent = patient.service;
                    const pat = document.createElement('div');
                    pat.className = 'queue-patient';
                    pat.textContent = `${patient.name} • ${patient.age} yrs • ${patient.gender}`;
                    left.appendChild(num);
                    left.appendChild(svc);
                    left.appendChild(pat);

                    li.appendChild(left);
                    queueListElement.appendChild(li);
                });
            }

            // Update ticket preview based on current state
            function updateTicketPreview() {
                if (selectedService || lastService) {
                    const service = selectedService || lastService;
                    ticketService.textContent = service;
                    ticketNumber.textContent = String(lastIssuedNumbers[service] + 1).padStart(3, '0');
                    
                    // Update patient info in ticket if available
                    const name = patientNameInput.value.trim();
                    const age = patientAgeInput.value.trim();
                    const gender = patientGenderSelect.value;
                    if (name && age && gender) {
                        ticketPatient.textContent = `Patient: ${name} • ${age} yrs • ${gender}`;
                    }
                } else {
                    ticketNumber.textContent = '--';
                    ticketService.textContent = 'Please select a service';
                    ticketPatient.textContent = 'Patient: —';
                }
            }

            // Update queue controls based on system state
            function updateQueueControls() {
                if (isQueueStarted) {
                    startQueueBtn.textContent = ' Queue Started';
                    startQueueBtn.innerHTML = '<i class="fas fa-check-circle"></i> Queue Started';
                    startQueueBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';
                } else {
                    startQueueBtn.textContent = ' Start Queue';
                    startQueueBtn.innerHTML = '<i class="fas fa-play-circle"></i> Start Queue';
                    startQueueBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';
                }
            }

            // Voice announcement function (Web Speech API)
            function announce(text) {
                if (!('speechSynthesis' in window)) {
                    console.warn('Speech Synthesis not supported in this browser.');
                    return;
                }
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.rate = 1;
                u.pitch = 1;
                if (speechSynthesis.speaking) {
                    try { speechSynthesis.cancel(); } catch (e) {}
                }
                speechSynthesis.speak(u);
            }

            // Show notification
            function showNotification(message, isError = false) {
                notification.innerHTML = isError ? 
                    '<i class="fas fa-exclamation-circle"></i><span>' + message + '</span>' :
                    '<i class="fas fa-check-circle"></i><span>' + message + '</span>';
                notification.className = isError ? 'notification error show' : 'notification show';
                setTimeout(() => { notification.className = 'notification'; }, 3000);
            }

            // Download data as CSV
            function downloadCSV(data, filename) {
                if (!data || data.length === 0) {
                    showNotification('No data available to download', true);
                    return;
                }
                
                // Create CSV headers
                const headers = Object.keys(data[0]).join(',');
                
                // Create CSV rows
                const rows = data.map(item => 
                    Object.values(item).map(value => 
                        typeof value === 'string' && value.includes(',') ? `"${value}"` : value
                    ).join(',')
                );
                
                // Combine headers and rows
                const csvContent = [headers, ...rows].join('\n');
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Data downloaded successfully!');
            }

            // Login
            loginBtn.addEventListener('click', function() {
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                const isValid = staffCredentials.some(cred => cred.username === username && cred.password === password);
                if (isValid) {
                    loginSection.style.display = 'none';
                    document.querySelector('.content').style.display = 'none';
                    mainSystem.style.display = 'block';
                    showNotification('Login successful! Welcome to Anchor Lab System');
                    
                    // Create service-specific next buttons
                    createNextButtons();
                    
                    // Check for daily reset and update UI
                    checkAndResetDailyNumbering();
                    updateQueueControls();
                    testFirebaseConnection();
                } else {
                    showNotification('Invalid username or password. Please try again.', true);
                }
            });

            // Helper: validate patient info
            function validatePatientInfo() {
                const name = patientNameInput.value.trim();
                const age = patientAgeInput.value;
                const gender = patientGenderSelect.value;
                if (!name) {
                    showNotification('Please enter patient name before selecting a service.', true);
                    return false;
                }
                if (!age || isNaN(age) || Number(age) < 0) {
                    showNotification('Please enter a valid age before selecting a service.', true);
                    return false;
                }
                if (!gender) {
                    showNotification('Please select gender before selecting a service.', true);
                    return false;
                }
                return true;
            }

            // Service selection: requires patient info first
            serviceButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (!validatePatientInfo()) {
                        return;
                    }

                    serviceButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    selectedService = this.getAttribute('data-service');
                    lastService = selectedService;

                    // Update ticket preview with service and patient
                    ticketService.textContent = selectedService;
                    const name = patientNameInput.value.trim();
                    const age = patientAgeInput.value.trim();
                    const gender = patientGenderSelect.value;
                    ticketPatient.textContent = `Patient: ${name} • ${age} yrs • ${gender}`;

                    // show the next ticket number for this service
                    ticketNumber.textContent = String(lastIssuedNumbers[selectedService] + 1).padStart(3, '0');
                });
            });

            // Start queue
            startQueueBtn.addEventListener('click', function() {
                isQueueStarted = true;
                saveToFirebase();
                showNotification('Queue has been started! Patients can now be added.');
            });

            // Add to queue when ticket preview clicked - UPDATED: Now service-specific numbering
            ticketPreview.addEventListener('click', function() {
                if (!selectedService && !lastService) {
                    showNotification('Please select a medical service first.', true);
                    return;
                }

                const name = patientNameInput.value.trim();
                const age = patientAgeInput.value.trim();
                const gender = patientGenderSelect.value;
                if (!name || !age || isNaN(age) || Number(age) < 0 || !gender) {
                    showNotification('Please fill valid patient Name, Age and Gender before adding.', true);
                    return;
                }

                if (!isQueueStarted) {
                    showNotification('Please start the queue first before adding patients.', true);
                    return;
                }

                const service = selectedService || lastService;
                
                // Number to assign is next after lastIssuedNumber for this service
                const number = String(lastIssuedNumbers[service] + 1).padStart(3, '0');

                // Create patient object with today's date
                const patient = {
                    number: number,
                    service: service,
                    name: name,
                    age: age,
                    gender: gender,
                    status: 'Waiting',
                    date: new Date().toISOString().split('T')[0] // Add today's date
                };

                // Add to queue for this service and patient lists
                queues[service].push(patient);
                allPatients.push(patient);
                todayPatients.push(patient); // Add to today's patients

                // Visual feedback for printing
                ticketPreview.classList.add('printing');
                
                // Create print window for roll paper
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Print Queue Ticket</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 3mm; 
                                font-family: 'Courier New', monospace;
                                width: 80mm;
                                font-size: 12px;
                                line-height: 1.2;
                            }
                            .ticket-header {
                                text-align: center;
                                margin-bottom: 5px;
                            }
                            .ticket-logo img {
                                max-width: 50px;
                                max-height: 50px;
                            }
                            .ticket-title {
                                font-size: 12px;
                                font-weight: bold;
                                line-height: 1.2;
                                margin-bottom: 5px;
                            }
                            h3 {
                                font-size: 11px;
                                margin: 3px 0;
                                text-align: center;
                                border-bottom: 1px dashed #000;
                                padding-bottom: 5px;
                            }
                            .ticket-number {
                                font-size: 42px;
                                font-weight: bold;
                                text-align: center;
                                margin: 15px 0;
                                color: #000;
                            }
                            .ticket-service {
                                font-size: 18px;
                                text-align: center;
                                margin-bottom: 5px;
                                font-weight: bold;
                            }
                            .ticket-patient {
                                font-size: 10px;
                                text-align: center;
                                margin-bottom: 5px;
                            }
                            .barcode-area {
                                margin: 10px 0;
                                text-align: center;
                                border-top: 1px dashed #000;
                                padding-top: 10px;
                            }
                            .barcode-placeholder {
                                height: 40px;
                                border: 1px solid #ccc;
                                margin: 5px auto;
                                width: 80%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 10px;
                                color: #666;
                            }
                            .ticket-footer {
                                font-size: 9px;
                                text-align: center;
                                margin-top: 10px;
                                border-top: 1px dashed #000;
                                padding-top: 8px;
                            }
                            hr {
                                border: none;
                                border-top: 1px dashed #000;
                                margin: 5px 0;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="ticket-header">
                            <div class="ticket-logo">
                                <img src="logo_anchor.png" alt="Logo" onerror="this.style.display='none'">
                            </div>
                            <div class="ticket-title">ANCHOR LAB & MEDICAL CENTER INC.</div>
                        </div>
                        <hr>
                        <h3>QUEUE TICKET</h3>
                        <div class="ticket-number">${number}</div>
                        <div class="ticket-service">${service}</div>
                        <div class="ticket-patient">Patient: ${name}</div>
                        <div class="ticket-patient">Age: ${age} yrs | Gender: ${gender}</div>
                        <div class="barcode-area">
                            <div class="barcode-placeholder">BARCODE AREA</div>
                        </div>
                        <div class="ticket-footer">
                            Please wait for your number to be called<br>
                            ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.print();
                    setTimeout(() => {
                        printWindow.close();
                    }, 500);
                }, 250);

                setTimeout(() => { 
                    ticketPreview.classList.remove('printing'); 
                }, 1000);

                // Mark that we've issued this number for this service
                lastIssuedNumbers[service] = lastIssuedNumbers[service] + 1;

                // Clear patient inputs so staff can add next patient
                patientNameInput.value = '';
                patientAgeInput.value = '';
                patientGenderSelect.value = '';

                // Save to Firebase (this will trigger real-time updates on all devices)
                saveToFirebase();

                showNotification('Ticket ' + number + ' added to ' + service + ' queue');
            });

            // Show demographics
            demographicsBtn.addEventListener('click', function() {
                updateDemographicsTable();
                demographicsSection.style.display = 'block';
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            });

            // Update demographics table
            function updateDemographicsTable() {
                demographicsTableBody.innerHTML = '';
                
                if (allPatients.length === 0) {
                    demographicsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No patient data available</td></tr>';
                    return;
                }
                
                allPatients.forEach(patient => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${patient.number}</td>
                        <td>${patient.name}</td>
                        <td>${patient.age}</td>
                        <td>${patient.gender}</td>
                        <td>${patient.service}</td>
                        <td>${patient.status}</td>
                        <td>${patient.date || 'Unknown'}</td>
                    `;
                    demographicsTableBody.appendChild(row);
                });
            }

            // Print demographics
            printDemographicsBtn.addEventListener('click', function() {
                window.print();
            });

            // Download demographics data
            downloadDemographicsBtn.addEventListener('click', function() {
                const filename = `patient_demographics_${new Date().toISOString().split('T')[0]}.csv`;
                downloadCSV(allPatients, filename);
            });

            // Close demographics
            closeDemographicsBtn.addEventListener('click', function() {
                demographicsSection.style.display = 'none';
            });

            // Logout
            logoutBtn.addEventListener('click', function() {
                isQueueStarted = false;
                selectedService = null;
                lastService = null;
                currentDisplayPatient = null;

                ticketNumber.textContent = '--';
                ticketService.textContent = 'Please select a service';
                ticketPatient.textContent = 'Patient: —';

                serviceButtons.forEach(btn => btn.classList.remove('active'));

                startQueueBtn.textContent = ' Start Queue';
                startQueueBtn.innerHTML = '<i class="fas fa-play-circle"></i> Start Queue';
                startQueueBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';

                usernameInput.value = '';
                passwordInput.value = '';
                patientNameInput.value = '';
                patientAgeInput.value = '';
                patientGenderSelect.value = '';

                loginSection.style.display = 'block';
                document.querySelector('.content').style.display = 'flex';
                mainSystem.style.display = 'none';

                showNotification('Logged out successfully');
            });

            // Initialize UI
            ticketNumber.textContent = '--';
            ticketService.textContent = 'Please select a service';
            ticketPatient.textContent = 'Patient: —';
            
            // Initialize displays
            updateAllDisplays();
            updateDailyStats();
            updateRecentlyCalledDisplay(); // NEW: Initialize recently called display
            
            // Create service-specific next buttons
            createNextButtons();
            
            // Check for daily reset and test Firebase connection
            setTimeout(() => {
                checkAndResetDailyNumbering();
                testFirebaseConnection();
            }, 1000);
        });
    </script>
</body>
</html>