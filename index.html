<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Anchor Lab & Medical Center Inc. - Queuing System</title>
    <link rel="icon" type="image/x-icon" href="logo_anchor.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', Tahoma, Geneva, sans-serif; }
        body {
            background: linear-gradient(135deg, #f0f7fd 0%, #e6f2ff 100%);
            color: #2c3e50; line-height: 1.6; min-height: 100vh; padding: 20px;
        }
        .container { 
            width: 100%; 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        header {
            background: linear-gradient(135deg, #0d4d75 0%, #1a6fa0 100%); 
            color: white; 
            padding: 25px 0;
            text-align: center; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            position:relative;
        }
        .logo-container { 
            display:flex; 
            align-items:center; 
            margin-bottom:15px;
            background: rgba(255,255,255,0.15); 
            padding:15px 25px; 
            border-radius:12px; 
            backdrop-filter: blur(10px);
        }
        .logo { 
            width:100px; 
            height:100px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            margin-right:5px; 
        }
        .logo img { 
            max-width:100%; 
            max-height:100%; 
            object-fit:contain; 
        }
        .company-name h1 { 
            font-size:28px; 
            font-weight:700; 
            letter-spacing:0.5px; 
            margin:0; 
            line-height:1.2; 
        }
        .system-title { 
            font-size:22px; 
            font-weight:400; 
            margin-top:15px; 
            color:#e6f7ff; 
            padding:12px 25px;
            background: rgba(0,0,0,0.2); 
            border-radius:8px; 
        }
        .content { 
            display:flex; 
            flex-wrap:wrap; 
        }
        .login-section { 
            flex:1; 
            min-width:400px; 
            padding:40px; 
            background:white; 
            display:flex; 
            flex-direction:column; 
            justify-content:center; 
        }
        .display-section { 
            flex:1.2; 
            min-width:400px; 
            background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); 
            padding:30px; 
            border-left:1px solid #e0e0e0; 
            display: flex;
            flex-direction: column;
        }
        .login-header { 
            text-align:center; 
            margin-bottom:35px; 
        }
        .login-logo { 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            margin-bottom:10px; 
        }
        .login-logo .logo { 
            width:150px; 
            height:150px; 
            margin-right:20px; 
        }
        .login-title { 
            font-size:25px; 
            color:#1a6fa0; 
            font-weight:600; 
            margin-bottom:5px; 
        }
        .form-group { 
            margin-bottom:20px; 
            position:relative; 
        }
        .form-group label { 
            display:block; 
            margin-bottom:10px; 
            font-weight:600; 
            color:#495057; 
            font-size:16px; 
            display:flex; 
            align-items:center; 
        }
        .form-group label i { 
            margin-right:10px; 
            color:#1a6fa0; 
        }
        .form-group input, .form-group select { 
            width:100%; 
            padding:14px 16px 14px 50px; 
            border:2px solid #dee2e6; 
            border-radius:10px; 
            font-size:16px; 
            transition:all .3s; 
        }
        .form-group i.input-icon { 
            position:absolute; 
            left:16px; 
            top:44px; 
            color:#6c757d; 
            font-size:20px; 
        }
        .form-group input:focus, .form-group select:focus { 
            border-color:#4db8ff; 
            outline:none; 
            box-shadow:0 0 0 3px rgba(77,184,255,0.2); 
        }
        button { 
            background:linear-gradient(135deg,#1a6fa0 0%,#0d4d75 100%); 
            color:white; 
            border:none; 
            padding:18px 24px; 
            border-radius:10px; 
            cursor:pointer; 
            font-size:17px; 
            width:100%; 
            transition:all .3s; 
            font-weight:600; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
        }
        button i { 
            margin-right:10px; 
        }
        button:hover { 
            transform:translateY(-3px); 
            box-shadow:0 6px 12px rgba(0,0,0,0.15); 
        }
        .main-system { 
            display:none; 
            padding:30px; 
        }
        .staff-panel, .display-panel { 
            background:white; 
            border-radius:12px; 
            box-shadow:0 5px 15px rgba(0,0,0,0.08); 
            margin-bottom:30px; 
            padding:30px; 
            overflow:hidden; 
            border:1px solid #e0e0e0; 
        }
        .panel-header { 
            display:flex; 
            align-items:center; 
            margin-bottom:25px; 
            padding-bottom:20px; 
            border-bottom:2px solid #e9ecef; 
        }
        .panel-header i { 
            font-size:24px; 
            color:#1a6fa0; 
            margin-right:12px; 
            background:#e6f7ff; 
            padding:12px; 
            border-radius:10px; 
        }
        .panel-header h2 { 
            color:#1a6fa0; 
            font-size:24px; 
            margin:0; 
        }
        .service-buttons { 
            display:grid; 
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); 
            gap:16px; 
            margin-bottom:30px; 
        }
        .service-btn { 
            background:linear-gradient(135deg,#e6f7ff 0%,#cce5ff 100%); 
            color:#1a6fa0; 
            border:2px solid #4db8ff; 
            padding:18px; 
            border-radius:10px; 
            cursor:pointer; 
            text-align:center; 
            transition:all .3s; 
            font-weight:600; 
            font-size:16px; 
            box-shadow:0 4px 8px rgba(0,0,0,0.05); 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
        }
        .service-btn i { 
            font-size:24px; 
            margin-bottom:10px; 
            color:#1a6fa0; 
        }
        .service-btn:hover, .service-btn.active { 
            background:linear-gradient(135deg,#4db8ff 0%,#1a6fa0 100%); 
            color:white; 
            transform:translateY(-3px); 
            box-shadow:0 6px 12px rgba(77,184,255,0.3); 
        }
        .service-btn:hover i, .service-btn.active i { 
            color:white; 
        }
        .queue-controls { 
            display:flex; 
            justify-content:space-between; 
            margin-top:30px; 
            gap:18px; 
        }
        .control-btn { 
            width:48%; 
        }
        .start-btn { 
            background:linear-gradient(135deg,#28a745 0%,#1e7e34 100%); 
        }
        .next-btn { 
            background:linear-gradient(135deg,#ff9800 0%,#e65100 100%); 
        }
        .ticket-preview { 
            background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); 
            border:2px dashed #4db8ff; 
            padding:30px; 
            margin-top:30px; 
            text-align:center; 
            border-radius:12px; 
            transition:all .3s; 
            position:relative; 
            cursor:pointer; 
        }
        .ticket-header { 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            margin-bottom:20px; 
        }
        .ticket-logo { 
            width:100px; 
            height:100px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            margin-right:12px; 
        }
        .ticket-logo img { 
            max-width:100%; 
            max-height:100%; 
            object-fit:contain; 
        }
        .ticket-title { 
            font-size:20px; 
            font-weight:700; 
            color:#1a6fa0; 
        }
        .ticket-number { 
            font-size:52px; 
            font-weight:800; 
            color:#e53935; 
            margin:20px 0; 
            text-shadow:2px 2px 4px rgba(0,0,0,0.1); 
        }
        .ticket-service { 
            font-size:22px; 
            color:#6c757d; 
            font-weight:500; 
            margin-bottom:15px; 
        }
        .ticket-patient { 
            font-size:16px; 
            color:#495057; 
            font-weight:500; 
        }
        .ticket-preview.printing { 
            transform:scale(1.02); 
            box-shadow:0 12px 24px rgba(0,0,0,0.15); 
        }
        .display-screen { 
            background:linear-gradient(135deg,#1a6fa0 0%,#0d4d75 100%); 
            color:white; 
            padding:40px; 
            border-radius:12px; 
            text-align:center; 
            margin-bottom:30px; 
            box-shadow:0 12px 24px rgba(0,0,0,0.2); 
            /* FIX: Ensure display fits properly */
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .display-header { 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            margin-bottom:25px; 
        }
        .display-logo { 
            display:flex; 
            align-items:center; 
            margin-bottom:15px; 
        }
        .display-title { 
            font-size:28px; 
            font-weight:700; 
            color:#ffcb05; 
        }
        .current-number { 
            font-size:90px; 
            font-weight:800; 
            color:#ffcb05; 
            margin:30px 0; 
            text-shadow:3px 3px 6px rgba(0,0,0,0.3); 
        }
        .current-service { 
            font-size:30px; 
            color:#e6f7ff; 
        }
        .queue-list { 
            list-style:none; 
            margin-top:30px; 
            max-height:400px; 
            overflow-y:auto; 
            flex-grow: 1;
        }
        .queue-item { 
            background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); 
            padding:20px; 
            margin-bottom:15px; 
            border-radius:10px; 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            box-shadow:0 4px 8px rgba(0,0,0,0.08); 
            transition:all .3s; 
            border-left:5px solid #4db8ff; 
        }
        .queue-item .left { 
            display:flex; 
            align-items:center; 
            gap:12px; 
        }
        .queue-number { 
            font-weight:800; 
            font-size:20px; 
            color:#1a6fa0; 
            margin-right:12px; 
        }
        .queue-service { 
            color:#6c757d; 
            font-weight:500; 
            font-size:16px; 
        }
        .queue-patient { 
            color:#495057; 
            font-size:14px; 
            margin-left:10px; 
            font-weight:500; 
        }
        .now-serving { 
            background:linear-gradient(135deg,#fff8e1 0%,#ffecb3 100%); 
            border-left:5px solid #ff9800; 
        }
        .logout-btn { 
            background:linear-gradient(135deg,#e53935 0%,#b71c1c 100%); 
            max-width:220px; 
            margin:30px auto; 
            display:block; 
        }
        .notification { 
            position:fixed; 
            top:30px; 
            right:30px; 
            padding:18px 24px; 
            border-radius:10px; 
            background:linear-gradient(135deg,#28a745 0%,#1e7e34 100%); 
            color:white; 
            box-shadow:0 8px 16px rgba(0,0,0,0.2); 
            transform:translateX(100%); 
            transition:transform .3s ease-out; 
            z-index:1000; 
            font-weight:500; 
            display:flex; 
            align-items:center; 
        }
        .notification i { 
            margin-right:12px; 
            font-size:20px; 
        }
        .notification.error { 
            background:linear-gradient(135deg,#e53935 0%,#b71c1c 100%); 
        }
        .notification.show { 
            transform:translateX(0); 
        }
        .instructions { 
            background:linear-gradient(135deg,#e6f7ff 0%,#cce5ff 100%); 
            padding:20px; 
            border-radius:10px; 
            margin-bottom:25px; 
            border-left:5px solid #4db8ff; 
        }
        .instructions h3 { 
            color:#1a6fa0; 
            margin-bottom:15px; 
            display:flex; 
            align-items:center; 
        }
        .instructions h3 i { 
            margin-right:10px; 
        }
        .instructions ol { 
            padding-left:30px; 
        }
        .instructions li { 
            margin-bottom:12px; 
            color:#495057; 
        }
        .patient-info { 
            display:flex; 
            gap:12px; 
            margin-bottom:16px; 
            flex-wrap:wrap; 
        }
        .patient-info .form-group { 
            flex:1 1 220px; 
            margin-bottom:0; 
        }
        
        /* TV Display Button */
        .tv-display-btn { 
            background:linear-gradient(135deg,#9c27b0 0%,#6a1b9a 100%); 
            max-width: 280px; 
            margin: 20px 0; 
        }
        
        /* Demographics Section */
        .demographics-section { 
            display: none; 
            margin-top: 30px; 
        }
        .demographics-btn { 
            background:linear-gradient(135deg,#9c27b0 0%,#6a1b9a 100%); 
            max-width: 280px; 
            margin: 20px 0; 
        }
        .demographics-panel { 
            background:white; 
            border-radius:12px; 
            box-shadow:0 5px 15px rgba(0,0,0,0.08); 
            margin-bottom:30px; 
            padding:30px; 
            overflow:hidden; 
            border:1px solid #e0e0e0; 
        }
        .demographics-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        .demographics-table th, .demographics-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #e0e0e0; 
        }
        .demographics-table th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            color: #1a6fa0; 
        }
        .demographics-table tr:hover { 
            background-color: #f5f5f5; 
        }
        .demographics-actions { 
            display: flex; 
            gap: 15px; 
            margin-top: 20px; 
            flex-wrap: wrap; 
        }
        .print-demographics-btn { 
            background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%); 
            max-width: 200px; 
        }
        .download-demographics-btn { 
            background:linear-gradient(135deg,#2196f3 0%,#0d47a1 100%); 
            max-width: 200px; 
        }
        .close-demographics-btn { 
            background:linear-gradient(135deg,#607d8b 0%,#37474f 100%); 
            max-width: 200px; 
        }
        
        /* Backup Section */
        .backup-section { 
            display: none; 
            margin-top: 30px; 
        }
        .backup-btn { 
            background:linear-gradient(135deg,#ff9800 0%,#e65100 100%); 
            max-width: 280px; 
            margin: 20px 0; 
        }
        .backup-panel { 
            background:white; 
            border-radius:12px; 
            box-shadow:0 5px 15px rgba(0,0,0,0.08); 
            margin-bottom:30px; 
            padding:30px; 
            overflow:hidden; 
            border:1px solid #e0e0e0; 
        }
        .backup-controls { 
            display: flex; 
            gap: 15px; 
            margin-top: 20px; 
            flex-wrap: wrap; 
        }
        .save-backup-btn { 
            background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%); 
            max-width: 200px; 
        }
        .load-backup-btn { 
            background:linear-gradient(135deg,#2196f3 0%,#0d47a1 100%); 
            max-width: 200px; 
        }
        .date-selector { 
            display: flex; 
            gap: 15px; 
            margin: 20px 0; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        .date-selector label { 
            font-weight: 600; 
            color: #495057; 
        }
        .date-selector input { 
            padding: 10px; 
            border: 2px solid #dee2e6; 
            border-radius: 8px; 
        }
        .backup-stats { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 20px; 
        }
        .backup-stats h4 { 
            color: #1a6fa0; 
            margin-bottom: 10px; 
        }
        
        /* Debug button */
        .debug-btn { 
            background:linear-gradient(135deg,#607d8b 0%,#37474f 100%); 
            max-width: 200px; 
            margin: 10px 0; 
        }
        
        @media (max-width:900px) { 
            .content { 
                flex-direction:column; 
            } 
            .display-section { 
                border-left:none; 
                border-top:1px solid #e0e0e0; 
            } 
        }
        
        /* ROLL PAPER PRINTING STYLES - UPDATED FOR ROLL PAPER QUEUE TICKETS */
        @media print { 
            body * { 
                visibility:hidden; 
            } 
            .ticket-preview, .ticket-preview * { 
                visibility:visible; 
            } 
            .ticket-preview { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 80mm !important; /* Standard receipt paper width */
                min-height: 120mm !important; /* Increased height for queue ticket */
                border: none !important; 
                box-shadow: none !important;
                margin: 0 !important;
                padding: 5mm !important;
                background: white !important;
                font-size: 12px !important;
                transform: scale(1) !important;
                font-family: 'Courier New', monospace !important; /* Better for thermal printers */
            }
            .ticket-header {
                flex-direction: column !important;
                text-align: center !important;
                margin-bottom: 8px !important;
            }
            .ticket-logo {
                width: 50px !important; /* Smaller logo for roll paper */
                height: 50px !important;
                margin: 0 auto 5px !important;
            }
            .ticket-title {
                font-size: 14px !important;
                font-weight: bold !important;
                line-height: 1.2 !important;
                margin-bottom: 5px !important;
            }
            .ticket-preview h3 {
                font-size: 13px !important;
                margin: 5px 0 !important;
                border-bottom: 1px dashed #000 !important;
                padding-bottom: 5px !important;
            }
            .ticket-number {
                font-size: 42px !important; /* Larger number for queue ticket */
                margin: 15px 0 !important;
                font-weight: bold !important;
                color: #000 !important; /* Black for better thermal printing */
            }
            .ticket-service {
                font-size: 18px !important;
                margin-bottom: 8px !important;
                font-weight: bold !important;
            }
            .ticket-patient {
                font-size: 12px !important;
                margin-bottom: 5px !important;
            }
            
            /* Add barcode area for queue systems */
            .barcode-area {
                margin: 10px 0 !important;
                text-align: center !important;
                border-top: 1px dashed #000 !important;
                padding-top: 10px !important;
            }
            .barcode-placeholder {
                height: 40px !important;
                border: 1px solid #ccc !important;
                margin: 5px auto !important;
                width: 80% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 10px !important;
                color: #666 !important;
            }
            
            /* Footer with date and time */
            .ticket-footer {
                font-size: 10px !important;
                text-align: center !important;
                margin-top: 10px !important;
                border-top: 1px dashed #000 !important;
                padding-top: 8px !important;
            }
            
            /* Hide demographics panel when printing ticket */
            .demographics-panel, .demographics-panel * { 
                visibility: hidden !important; 
                display: none !important;
            }
            
            /* Hide any buttons or controls */
            button, .service-btn, .queue-controls, .instructions, .patient-info {
                display: none !important;
            }
        }
        
        /* FIX: Improved display layout to prevent cut-off */
        .display-section h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #1a6fa0;
        }
        
        /* FIX: Ensure display screen fits properly */
        .display-screen .display-header {
            margin-bottom: 10px;
        }
        
        /* FIX: Adjust display for smaller screens */
        @media (max-width: 768px) {
            .display-screen {
                padding: 20px;
            }
            .current-number {
                font-size: 60px;
            }
            .current-service {
                font-size: 20px;
            }
        }
        
        /* Connection status indicator */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .connection-status.connected {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }
        .connection-status.disconnected {
            background: linear-gradient(135deg, #e53935 0%, #b71c1c 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo">
                    <img src="logo_anchor.png" alt="Anchor Lab & Medical Center Inc. Logo">
                </div>
                <div class="company-name">
                    <h1>ANCHOR LAB & MEDICAL CENTER INC.</h1>
                </div>
            </div>
            <div class="system-title">Patient Queuing System</div>
        </header>

        <div class="content">
            <section class="login-section" id="loginSection">
                <div class="login-header">
                    <div class="login-logo">
                        <div class="logo">
                            <img src="logo_anchor.png" alt="Anchor Lab & Medical Center Inc. Logo">
                        </div>
                        <div>
                            <div class="login-title">ANCHOR LAB &</div>
                            <div class="login-title">MEDICAL CENTER INC.</div>
                        </div>
                    </div>
                    <h2>Staff Login Portal</h2>
                </div>
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" placeholder="Enter your username">
                    <i class="fas fa-user input-icon"></i>
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" placeholder="Enter your password">
                    <i class="fas fa-lock input-icon"></i>
                </div>
                <button id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login to System</button>
            </section>

            <section class="display-section">
                <div class="display-screen">
                    <div class="display-header">
                        <div class="display-logo">
                            <div class="logo">
                                <img src="logo_anchor.png" alt="Logo">
                            </div>
                            <div class="display-title">ANCHOR LAB & MEDICAL CENTER INC.</div>
                        </div>
                    </div>
                    <h3>Now Serving</h3>
                    <div class="current-number" id="publicCurrentNumber">--</div>
                    <div class="current-service" id="publicCurrentService">Please wait for your number</div>
                </div>

                <h3><i class="fas fa-clock"></i> Waiting Queue</h3>
                <ul class="queue-list" id="publicQueueList">
                    <li class="queue-item">No patients in queue</li>
                </ul>
            </section>
        </div>

        <section class="main-system" id="mainSystem">
            <div class="staff-panel">
                <div class="panel-header">
                    <i class="fas fa-user-md"></i>
                    <h2>Staff Control Panel</h2>
                </div>

                <div class="instructions">
                    <h3><i class="fas fa-info-circle"></i> How to Use the System:</h3>
                    <ol>
                        <li>Enter patient Name, Age and Gender first.</li>
                        <li>Select a medical service (this requires patient details).</li>
                        <li>Click the ticket preview to print and add the patient to the queue.</li>
                        <li>Click "Next Patient" when ready to call the next person.</li>
                    </ol>
                </div>

                <!-- Patient info area -->
                <div class="patient-info">
                    <div class="form-group">
                        <label for="patientName"><i class="fas fa-id-card"></i> Patient Name</label>
                        <input type="text" id="patientName" placeholder="Full name">
                        <i class="fas fa-id-card input-icon"></i>
                    </div>
                    <div class="form-group">
                        <label for="patientAge"><i class="fas fa-birthday-cake"></i> Age</label>
                        <input type="number" id="patientAge" placeholder="Age" min="0">
                        <i class="fas fa-birthday-cake input-icon"></i>
                    </div>
                    <div class="form-group">
                        <label for="patientGender"><i class="fas fa-venus-mars"></i> Gender</label>
                        <select id="patientGender">
                            <option value="">Select gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        <i class="fas fa-venus-mars input-icon"></i>
                    </div>
                </div>

                <div class="service-buttons">
                    <div class="service-btn" data-service="2D Echo"><i class="fas fa-heart"></i> 2D Echo</div>
                    <div class="service-btn" data-service="X-Ray"><i class="fas fa-x-ray"></i> X-Ray</div>
                    <div class="service-btn" data-service="Drug Test"><i class="fas fa-pills"></i> Drug Test</div>
                    <div class="service-btn" data-service="Ultrasound"><i class="fas fa-baby"></i> Ultrasound</div>
                    <div class="service-btn" data-service="Blood Test"><i class="fas fa-tint"></i> Blood Test</div>
                    <div class="service-btn" data-service="ECG"><i class="fas fa-heartbeat"></i> ECG</div>
                    <div class="service-btn" data-service="Dental"><i class="fas fa-tooth"></i> Dental</div>
                    <div class="service-btn" data-service="CBC"><i class="fas fa-vial"></i> CBC</div>
                </div>

                <div class="ticket-preview" id="ticketPreview" title="Click to print/add ticket">
                    <div class="ticket-header">
                        <div class="ticket-logo">
                            <img src="logo_anchor.png" alt="Logo">
                        </div>
                        <div class="ticket-title">ANCHOR LAB & MEDICAL CENTER INC.</div>
                    </div>
                    <h3>Patient Queue Ticket</h3>
                    <div class="ticket-number" id="ticketNumber">--</div>
                    <div class="ticket-service" id="ticketService">Please select a service</div>
                    <div class="ticket-patient" id="ticketPatient">Patient: —</div>
                </div>

                <div class="queue-controls">
                    <button class="control-btn start-btn" id="startQueueBtn"><i class="fas fa-play-circle"></i> Start Queue</button>
                    <button class="control-btn next-btn" id="nextBtn"><i class="fas fa-forward"></i> Next Patient</button>
                </div>

                <!-- TV Display Button -->
                <button class="tv-display-btn" id="tvDisplayBtn"><i class="fas fa-tv"></i> Open TV Display</button>

                <button class="demographics-btn" id="demographicsBtn"><i class="fas fa-chart-bar"></i> View Demographics</button>
                
                <button class="backup-btn" id="backupBtn"><i class="fas fa-database"></i> Backup & Restore Data</button>
                
                <button class="debug-btn" id="debugBtn"><i class="fas fa-bug"></i> Debug Data (Console)</button>

                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>

            <div class="display-panel">
                <div class="panel-header">
                    <i class="fas fa-tv"></i>
                    <h2>Patient Display Screen</h2>
                </div>

                <div class="display-screen">
                    <div class="display-header">
                        <div class="display-logo">
                            <div class="logo">
                                <img src="logo_anchor.png" alt="Logo">
                            </div>
                            <div class="display-title">ANCHOR LAB & MEDICAL CENTER INC.</div>
                        </div>
                    </div>
                    <h3>Now Serving</h3>
                    <div class="current-number" id="currentNumber">--</div>
                    <div class="current-service" id="currentService">Please wait for your number</div>
                </div>

                <h3><i class="fas fa-clock"></i> Waiting Queue</h3>
                <ul class="queue-list" id="queueListDisplay">
                    <li class="queue-item">No patients in queue</li>
                </ul>
            </div>

            <!-- Demographics Section -->
            <div class="demographics-section" id="demographicsSection">
                <div class="demographics-panel">
                    <div class="panel-header">
                        <i class="fas fa-chart-bar"></i>
                        <h2>Patient Demographics</h2>
                    </div>
                    
                    <p>This section shows demographic data of patients who have used the queuing system.</p>
                    
                    <table class="demographics-table" id="demographicsTable">
                        <thead>
                            <tr>
                                <th>Ticket No.</th>
                                <th>Patient Name</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Service</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="demographicsTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                    
                    <div class="demographics-actions">
                        <button class="print-demographics-btn" id="printDemographicsBtn">
                            <i class="fas fa-print"></i> Print Demographics
                        </button>
                        <button class="download-demographics-btn" id="downloadDemographicsBtn">
                            <i class="fas fa-download"></i> Download Data
                        </button>
                        <button class="close-demographics-btn" id="closeDemographicsBtn">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Backup Section -->
            <div class="backup-section" id="backupSection">
                <div class="backup-panel">
                    <div class="panel-header">
                        <i class="fas fa-database"></i>
                        <h2>Daily Data Backup & Restore</h2>
                    </div>
                    
                    <p>Save today's patient data or load data from a previous day.</p>
                    
                    <div class="backup-controls">
                        <button class="save-backup-btn" id="saveBackupBtn">
                            <i class="fas fa-save"></i> Save Today's Data
                        </button>
                        <button class="load-backup-btn" id="loadBackupBtn">
                            <i class="fas fa-folder-open"></i> Load Data
                        </button>
                    </div>
                    
                    <div class="date-selector">
                        <label for="backupDate">Select Date:</label>
                        <input type="date" id="backupDate">
                    </div>
                    
                    <div class="backup-stats" id="backupStats">
                        <h4>Data Statistics</h4>
                        <p>Total Patients: <span id="totalPatients">0</span></p>
                        <p>Services Today: <span id="servicesToday">0</span></p>
                        <p>Last Backup: <span id="lastBackup">Never</span></p>
                    </div>
                    
                    <table class="demographics-table" id="backupTable">
                        <thead>
                            <tr>
                                <th>Ticket No.</th>
                                <th>Patient Name</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Service</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="backupTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                    
                    <div class="demographics-actions">
                        <button class="print-demographics-btn" id="printBackupBtn">
                            <i class="fas fa-print"></i> Print Backup Data
                        </button>
                        <button class="download-demographics-btn" id="downloadBackupBtn">
                            <i class="fas fa-download"></i> Download Backup
                        </button>
                        <button class="close-demographics-btn" id="closeBackupBtn">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <div class="footer">
            <p>© 2025 Anchor Lab & Medical Center Inc. - Patient Queuing v1.0</p>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span>Patient added to queue successfully!</span>
    </div>

    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i>
        <span>Connecting...</span>
    </div>

    <script>
        // Firebase Configuration - YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAXYZqlx4vGtcifEWvFqOVFrrZUBkFoXEs",
            authDomain: "anchor-lab-queue.firebaseapp.com",
            databaseURL: "https://anchor-lab-queue-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "anchor-lab-queue",
            storageBucket: "anchor-lab-queue.firebasestorage.app",
            messagingSenderId: "817997274125",
            appId: "1:817997274125:web:148493e8972c42c4a80944",
            measurementId: "G-BV8C2KTS8V"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const loginSection = document.getElementById('loginSection');
            const mainSystem = document.getElementById('mainSystem');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const serviceButtons = document.querySelectorAll('.service-btn');
            const ticketNumber = document.getElementById('ticketNumber');
            const ticketService = document.getElementById('ticketService');
            const ticketPreview = document.getElementById('ticketPreview');
            const startQueueBtn = document.getElementById('startQueueBtn');
            const nextBtn = document.getElementById('nextBtn');
            const currentNumber = document.getElementById('currentNumber');
            const currentService = document.getElementById('currentService');
            const queueList = document.getElementById('queueListDisplay');
            const logoutBtn = document.getElementById('logoutBtn');
            const notification = document.getElementById('notification');
            const connectionStatus = document.getElementById('connectionStatus');
            
            // Public display elements
            const publicCurrentNumber = document.getElementById('publicCurrentNumber');
            const publicCurrentService = document.getElementById('publicCurrentService');
            const publicQueueList = document.getElementById('publicQueueList');
            
            // TV Display button
            const tvDisplayBtn = document.getElementById('tvDisplayBtn');
            
            // Demographics elements
            const demographicsBtn = document.getElementById('demographicsBtn');
            const demographicsSection = document.getElementById('demographicsSection');
            const demographicsTableBody = document.getElementById('demographicsTableBody');
            const printDemographicsBtn = document.getElementById('printDemographicsBtn');
            const downloadDemographicsBtn = document.getElementById('downloadDemographicsBtn');
            const closeDemographicsBtn = document.getElementById('closeDemographicsBtn');
            
            // Backup elements
            const backupBtn = document.getElementById('backupBtn');
            const backupSection = document.getElementById('backupSection');
            const saveBackupBtn = document.getElementById('saveBackupBtn');
            const loadBackupBtn = document.getElementById('loadBackupBtn');
            const backupDateInput = document.getElementById('backupDate');
            const backupTableBody = document.getElementById('backupTableBody');
            const printBackupBtn = document.getElementById('printBackupBtn');
            const downloadBackupBtn = document.getElementById('downloadBackupBtn');
            const closeBackupBtn = document.getElementById('closeBackupBtn');
            const totalPatientsSpan = document.getElementById('totalPatients');
            const servicesTodaySpan = document.getElementById('servicesToday');
            const lastBackupSpan = document.getElementById('lastBackup');
            
            // Debug button
            const debugBtn = document.getElementById('debugBtn');

            // Patient fields
            const patientNameInput = document.getElementById('patientName');
            const patientAgeInput = document.getElementById('patientAge');
            const patientGenderSelect = document.getElementById('patientGender');
            const ticketPatient = document.getElementById('ticketPatient');

            // System State
            let isQueueStarted = false;
            let queue = []; // will hold objects { number, service, name, age, gender, status }
            let allPatients = []; // will hold all patient objects for demographics
            let lastIssuedNumber = 0; // last assigned ticket number
            let selectedService = null;
            let lastService = null;
            let tvDisplayWindow = null;

            // Staff credentials (in a real system, this would be handled server-side)
            const staffCredentials = [
                { username: 'staff1', password: 'pass1' },
                { username: 'staff2', password: 'pass2' },
                { username: 'admin', password: 'admin123' }
            ];

            // Room mapping for services - ADDED FOR ROOM ANNOUNCEMENTS
            const serviceRooms = {
                "2D Echo": "Room 1",
                "X-Ray": "Room 2",
                "Drug Test": "Room 3",
                "Ultrasound": "Room 4",
                "Blood Test": "Room 5",
                "ECG": "Room 6",
                "Dental": "Room 3",
                "CBC": "Room 5"
            };

            // Firebase Realtime Database Reference
            const queueRef = database.ref('queue');
            const systemRef = database.ref('system');

            // Firebase Connection Status
            database.ref('.info/connected').on('value', function(snap) {
                if (snap.val() === true) {
                    connectionStatus.innerHTML = '<i class="fas fa-wifi"></i><span>Connected</span>';
                    connectionStatus.className = 'connection-status connected';
                } else {
                    connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline</span>';
                    connectionStatus.className = 'connection-status disconnected';
                }
            });

            // Listen for real-time queue updates from Firebase
            queueRef.on('value', function(snapshot) {
                const data = snapshot.val();
                if (data) {
                    queue = data.queue || [];
                    allPatients = data.allPatients || [];
                    lastIssuedNumber = data.lastIssuedNumber || 0;
                    isQueueStarted = data.isQueueStarted || false;
                    
                    // Update UI
                    updateQueueDisplay();
                    updatePublicDisplay();
                    updateTicketPreview();
                    
                    // Update staff panel if logged in
                    if (mainSystem.style.display === 'block') {
                        updateQueueControls();
                    }
                }
            });

            // Update ticket preview based on current state
            function updateTicketPreview() {
                if (selectedService || lastService) {
                    ticketService.textContent = selectedService || lastService;
                    ticketNumber.textContent = String(lastIssuedNumber + 1).padStart(3, '0');
                } else {
                    ticketNumber.textContent = '--';
                    ticketService.textContent = 'Please select a service';
                }
            }

            // Update queue controls based on system state
            function updateQueueControls() {
                if (isQueueStarted) {
                    startQueueBtn.textContent = ' Queue Started';
                    startQueueBtn.innerHTML = '<i class="fas fa-check-circle"></i> Queue Started';
                    startQueueBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';
                } else {
                    startQueueBtn.textContent = ' Start Queue';
                    startQueueBtn.innerHTML = '<i class="fas fa-play-circle"></i> Start Queue';
                    startQueueBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';
                }
            }

            // FIX: Improved display update function
            function updatePublicDisplay() {
                if (queue.length > 0) {
                    const currentPatient = queue[0];
                    publicCurrentNumber.textContent = currentPatient.number;
                    publicCurrentService.textContent = currentPatient.service;
                    
                    // Update staff display too
                    currentNumber.textContent = currentPatient.number;
                    currentService.textContent = currentPatient.service + (currentPatient.name ? ' — ' + currentPatient.name : '');
                } else {
                    publicCurrentNumber.textContent = '--';
                    publicCurrentService.textContent = 'Please wait for your number';
                    currentNumber.textContent = '--';
                    currentService.textContent = 'No patients in queue';
                }
                
                // Update public queue list
                updatePublicQueueList();
            }
            
            // FIX: Update public queue list
            function updatePublicQueueList() {
                if (queue.length === 0) {
                    publicQueueList.innerHTML = '<li class="queue-item">No patients in queue</li>';
                    return;
                }

                publicQueueList.innerHTML = '';
                queue.forEach(patient => {
                    const li = document.createElement('li');
                    li.className = 'queue-item';
                    const left = document.createElement('div');
                    left.className = 'left';
                    const num = document.createElement('div');
                    num.className = 'queue-number';
                    num.textContent = patient.number;
                    const svc = document.createElement('div');
                    svc.className = 'queue-service';
                    svc.textContent = patient.service;
                    const pat = document.createElement('div');
                    pat.className = 'queue-patient';
                    pat.textContent = `${patient.name} • ${patient.age} yrs • ${patient.gender}`;
                    left.appendChild(num);
                    left.appendChild(svc);
                    left.appendChild(pat);

                    li.appendChild(left);
                    publicQueueList.appendChild(li);
                });
            }

            // Helper function to format date for input (YYYY-MM-DD)
            function formatDateForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Helper function to format date for display
            function formatDateForDisplay(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US');
            }

            // Initialize backup date to today
            backupDateInput.value = formatDateForInput(new Date());

            // Voice announcement function (Web Speech API) - UPDATED WITH ROOMS
            function announce(text) {
                if (!('speechSynthesis' in window)) {
                    console.warn('Speech Synthesis not supported in this browser.');
                    return;
                }
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.rate = 1;
                u.pitch = 1;
                if (speechSynthesis.speaking) {
                    try { speechSynthesis.cancel(); } catch (e) {}
                }
                speechSynthesis.speak(u);
            }

            // Show notification
            function showNotification(message, isError = false) {
                notification.innerHTML = isError ? 
                    '<i class="fas fa-exclamation-circle"></i><span>' + message + '</span>' :
                    '<i class="fas fa-check-circle"></i><span>' + message + '</span>';
                notification.className = isError ? 'notification error show' : 'notification show';
                setTimeout(() => { notification.className = 'notification'; }, 3000);
            }

            // Download data as CSV
            function downloadCSV(data, filename) {
                if (!data || data.length === 0) {
                    showNotification('No data available to download', true);
                    return;
                }
                
                // Create CSV headers
                const headers = Object.keys(data[0]).join(',');
                
                // Create CSV rows
                const rows = data.map(item => 
                    Object.values(item).map(value => 
                        typeof value === 'string' && value.includes(',') ? `"${value}"` : value
                    ).join(',')
                );
                
                // Combine headers and rows
                const csvContent = [headers, ...rows].join('\n');
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Data downloaded successfully!');
            }

            // Save data to Firebase
            function saveToFirebase() {
                const dataToSave = {
                    queue: queue,
                    allPatients: allPatients,
                    lastIssuedNumber: lastIssuedNumber,
                    isQueueStarted: isQueueStarted,
                    timestamp: new Date().toISOString()
                };
                
                queueRef.set(dataToSave)
                    .then(() => {
                        console.log('Data saved to Firebase');
                    })
                    .catch((error) => {
                        console.error('Error saving to Firebase:', error);
                        showNotification('Error saving data to cloud', true);
                    });
            }

            // Update TV display
            function updateTVDisplay() {
                if (tvDisplayWindow && !tvDisplayWindow.closed) {
                    // Send data directly to the TV display window
                    const displayData = {
                        currentPatient: queue.length > 0 ? queue[0] : null,
                        queue: queue,
                        isQueueStarted: isQueueStarted
                    };
                    
                    try {
                        tvDisplayWindow.postMessage(displayData, '*');
                    } catch (e) {
                        console.error('Error updating TV display:', e);
                    }
                }
            }

            // Load today's data from localStorage
            function loadTodayData() {
                const today = new Date();
                const todayKey = formatDateForInput(today);
                loadDataForDate(todayKey);
            }

            // Load data for a specific date
            function loadDataForDate(date) {
                console.log('Loading data for date:', date);
                
                // Check if date is in correct format, if not try to parse it
                let searchDate = date;
                if (!date.includes('-')) {
                    // If date is in MM/DD/YYYY format, convert to YYYY-MM-DD
                    const dateParts = date.split('/');
                    if (dateParts.length === 3) {
                        searchDate = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;
                    }
                }
                
                const savedData = localStorage.getItem(`queueData_${searchDate}`);
                console.log('Looking for key:', `queueData_${searchDate}`);
                console.log('Found data:', savedData);
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Update backup table
                    backupTableBody.innerHTML = '';
                    if (data.allPatients && data.allPatients.length > 0) {
                        data.allPatients.forEach(patient => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${patient.number}</td>
                                <td>${patient.name}</td>
                                <td>${patient.age}</td>
                                <td>${patient.gender}</td>
                                <td>${patient.service}</td>
                                <td>${patient.status || 'Unknown'}</td>
                            `;
                            backupTableBody.appendChild(row);
                        });
                        showNotification(`Data loaded for ${formatDateForDisplay(searchDate)} - ${data.allPatients.length} patients found`);
                    } else {
                        backupTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No data available for this date</td></tr>';
                        showNotification('No patient data found for the selected date', true);
                    }
                } else {
                    backupTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No data available for this date</td></tr>';
                    showNotification('No data found for the selected date', true);
                }
                
                updateBackupStats();
            }

            // Update backup statistics
            function updateBackupStats() {
                const today = new Date();
                const todayKey = formatDateForInput(today);
                const savedData = localStorage.getItem(`queueData_${todayKey}`);
                
                console.log('Updating stats for date:', todayKey);
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    totalPatientsSpan.textContent = data.allPatients ? data.allPatients.length : 0;
                    
                    // Count unique services
                    if (data.allPatients && data.allPatients.length > 0) {
                        const services = new Set(data.allPatients.map(p => p.service));
                        servicesTodaySpan.textContent = services.size;
                    } else {
                        servicesTodaySpan.textContent = 0;
                    }
                    
                    lastBackupSpan.textContent = new Date(data.timestamp).toLocaleString();
                } else {
                    // Show current session data if no saved data
                    totalPatientsSpan.textContent = allPatients.length;
                    
                    // Count unique services from current session
                    const services = new Set(allPatients.map(p => p.service));
                    servicesTodaySpan.textContent = services.size;
                    
                    lastBackupSpan.textContent = 'Never';
                }
            }

            // Debug function to see all stored data
            function debugStoredData() {
                console.log('=== ALL STORED DATA ===');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('queueData_')) {
                        console.log(key, localStorage.getItem(key));
                    }
                }
                console.log('=== END STORED DATA ===');
                showNotification('Check browser console for stored data');
            }

            // Open TV Display
            tvDisplayBtn.addEventListener('click', function() {
                // Open a new tab with the TV display
                tvDisplayWindow = window.open('', '_blank');
                
                // Write the TV display HTML to the new window
                tvDisplayWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Anchor Lab - Patient Display</title>
                        <style>
                            * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', Tahoma, Geneva, sans-serif; }
                            body {
                                background: linear-gradient(135deg, #1a6fa0 0%, #0d4d75 100%);
                                color: white; line-height: 1.6; min-height: 100vh; padding: 20px;
                                overflow: hidden;
                            }
                            .container { 
                                width: 100%; 
                                height: 100vh;
                                margin: 0 auto; 
                                background: white; 
                                border-radius: 15px;
                                box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
                                overflow: hidden; 
                                display: flex;
                                flex-direction: column;
                            }
                            header {
                                background: linear-gradient(135deg, #0d4d75 0%, #1a6fa0 100%); 
                                color: white; 
                                padding: 20px 0;
                                text-align: center; 
                                display:flex; 
                                flex-direction:column; 
                                align-items:center; 
                                position:relative;
                            }
                            .logo-container { 
                                display:flex; 
                                align-items:center; 
                                margin-bottom:10px;
                                background: rgba(255,255,255,0.15); 
                                padding:10px 20px; 
                                border-radius:12px; 
                                backdrop-filter: blur(10px);
                            }
                            .logo { 
                                width:80px; 
                                height:80px; 
                                display:flex; 
                                align-items:center; 
                                justify-content:center; 
                                margin-right:5px; 
                            }
                            .logo img { 
                                max-width:100%; 
                                max-height:100%; 
                                object-fit:contain; 
                            }
                            .company-name h1 { 
                                font-size:24px; 
                                font-weight:700; 
                                letter-spacing:0.5px; 
                                margin:0; 
                                line-height:1.2; 
                            }
                            .system-title {
                                font-size:18px; 
                                font-weight:400; 
                                margin-top:10px; 
                                color:#e6f7ff; 
                                padding:8px 20px;
                                background: rgba(0,0,0,0.2); 
                                border-radius:8px; 
                            }
                            .display-screen { 
                                background: linear-gradient(135deg, #1a6fa0 0%, #0d4d75 100%); 
                                color: white; 
                                padding: 30px; 
                                border-radius: 12px; 
                                text-align: center; 
                                margin: 20px;
                                box-shadow: 0 12px 24px rgba(0,0,0,0.2); 
                                flex: 1;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                            }
                            .display-header { 
                                display: flex; 
                                flex-direction: column; 
                                align-items: center; 
                                margin-bottom: 20px; 
                            }
                            .display-logo { 
                                display: flex; 
                                align-items: center; 
                                margin-bottom: 10px; 
                            }
                            .display-title { 
                                font-size: 24px; 
                                font-weight: 700; 
                                color: #ffcb05; 
                            }
                            .current-number { 
                                font-size: 120px; 
                                font-weight: 800; 
                                color: #ffcb05; 
                                margin: 20px 0; 
                                text-shadow: 3px 3px 6px rgba(0,0,0,0.3); 
                            }
                            .current-service { 
                                font-size: 36px; 
                                color: #e6f7ff; 
                                margin-bottom: 10px;
                            }
                            .current-patient {
                                font-size: 24px;
                                color: #e6f7ff;
                                margin-bottom: 20px;
                            }
                            .queue-section {
                                padding: 20px;
                                flex: 1;
                                overflow: auto;
                            }
                            .queue-list { 
                                list-style: none; 
                                margin-top: 20px; 
                                max-height: 100%; 
                                overflow-y: auto; 
                            }
                            .queue-item { 
                                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                                padding: 15px; 
                                margin-bottom: 10px; 
                                border-radius: 10px; 
                                display: flex; 
                                justify-content: space-between; 
                                align-items: center; 
                                box-shadow: 0 4px 8px rgba(0,0,0,0.08); 
                                transition: all .3s; 
                                border-left: 5px solid #4db8ff; 
                            }
                            .queue-item .left { 
                                display: flex; 
                                align-items: center; 
                                gap: 12px; 
                            }
                            .queue-number { 
                                font-weight: 800; 
                                font-size: 20px; 
                                color: #1a6fa0; 
                                margin-right: 12px; 
                            }
                            .queue-service { 
                                color: #6c757d; 
                                font-weight: 500; 
                                font-size: 16px; 
                            }
                            .queue-patient { 
                                color: #495057; 
                                font-size: 14px; 
                                margin-left: 10px; 
                                font-weight: 500; 
                            }
                            .now-serving { 
                                background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); 
                                border-left: 5px solid #ff9800; 
                            }
                            h3 { 
                                color: #1a6fa0; 
                                margin: 15px 0; 
                                text-align: center; 
                                font-size: 22px; 
                            }
                            h3 i { 
                                margin-right: 10px; 
                                color: #1a6fa0; 
                            }
                            .waiting-message {
                                text-align: center;
                                font-size: 18px;
                                color: #6c757d;
                                margin-top: 20px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <header>
                                <div class="logo-container">
                                    <div class="logo">
                                        <img src="logo_anchor.png" alt="Anchor Lab & Medical Center Inc. Logo">
                                    </div>
                                    <div class="company-name">
                                        <h1>ANCHOR LAB & MEDICAL CENTER INC.</h1>
                                    </div>
                                </div>
                                <div class="system-title">Patient Display Screen</div>
                            </header>
                            
                            <div class="display-screen">
                                <div class="display-header">
                                    <div class="display-logo">
                                        <div class="logo">
                                            <img src="logo_anchor.png" alt="Logo">
                                        </div>
                                        <div class="display-title">ANCHOR LAB & MEDICAL CENTER INC.</div>
                                    </div>
                                </div>
                                <h3>Now Serving</h3>
                                <div class="current-number" id="tvCurrentNumber">--</div>
                                <div class="current-service" id="tvCurrentService">Please wait for your number</div>
                                <div class="current-patient" id="tvCurrentPatient"></div>
                            </div>
                            
                            <div class="queue-section">
                                <h3><i class="fas fa-clock"></i> Waiting Queue</h3>
                                <ul class="queue-list" id="tvQueueList">
                                    <li class="queue-item">No patients in queue</li>
                                </ul>
                            </div>
                        </div>
                        
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"><\/script>
                        <script>
                            // Function to update TV display with data from main system
                            function updateTVDisplay(data) {
                                console.log('TV Display: Received data', data);
                                
                                // Update current number and service
                                if (data.currentPatient) {
                                    document.getElementById('tvCurrentNumber').textContent = data.currentPatient.number;
                                    document.getElementById('tvCurrentService').textContent = data.currentPatient.service;
                                    document.getElementById('tvCurrentPatient').textContent = data.currentPatient.name + ' • ' + data.currentPatient.age + ' yrs • ' + data.currentPatient.gender;
                                } else {
                                    document.getElementById('tvCurrentNumber').textContent = '--';
                                    document.getElementById('tvCurrentService').textContent = 'Please wait for your number';
                                    document.getElementById('tvCurrentPatient').textContent = '';
                                }
                                
                                // Update queue list
                                const tvQueueList = document.getElementById('tvQueueList');
                                if (data.queue && data.queue.length > 0) {
                                    tvQueueList.innerHTML = '';
                                    // Start from index 1 to skip the current patient (index 0)
                                    for (let i = 1; i < data.queue.length; i++) {
                                        const patient = data.queue[i];
                                        const li = document.createElement('li');
                                        li.className = 'queue-item';
                                        const left = document.createElement('div');
                                        left.className = 'left';
                                        const num = document.createElement('div');
                                        num.className = 'queue-number';
                                        num.textContent = patient.number;
                                        const svc = document.createElement('div');
                                        svc.className = 'queue-service';
                                        svc.textContent = patient.service;
                                        const pat = document.createElement('div');
                                        pat.className = 'queue-patient';
                                        pat.textContent = patient.name + ' • ' + patient.age + ' yrs • ' + patient.gender;
                                        left.appendChild(num);
                                        left.appendChild(svc);
                                        left.appendChild(pat);
                                        li.appendChild(left);
                                        tvQueueList.appendChild(li);
                                    }
                                    
                                    // If no patients in waiting queue (only current patient)
                                    if (data.queue.length === 1) {
                                        tvQueueList.innerHTML = '<div class="waiting-message">No patients in waiting queue</div>';
                                    }
                                } else {
                                    tvQueueList.innerHTML = '<div class="waiting-message">No patients in queue</div>';
                                }
                            }
                            
                            // Listen for messages from the main system
                            window.addEventListener('message', function(event) {
                                if (event.data) {
                                    updateTVDisplay(event.data);
                                }
                            });
                            
                            // Request initial data
                            if (window.opener && !window.opener.closed) {
                                window.opener.postMessage('requestData', '*');
                            }
                        <\/script>
                    </body>
                    </html>
                `);
                tvDisplayWindow.document.close();
                
                // Set up the unload event to clear the reference
                tvDisplayWindow.onbeforeunload = function() {
                    tvDisplayWindow = null;
                };
                
                showNotification('TV Display opened in new tab');
                
                // Update TV display with current data after a short delay to ensure the window is ready
                setTimeout(updateTVDisplay, 500);
            });

            // Listen for messages from TV display
            window.addEventListener('message', function(event) {
                if (event.data === 'requestData') {
                    updateTVDisplay();
                }
            });

            // Login
            loginBtn.addEventListener('click', function() {
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                const isValid = staffCredentials.some(cred => cred.username === username && cred.password === password);
                if (isValid) {
                    loginSection.style.display = 'none';
                    document.querySelector('.content').style.display = 'none';
                    mainSystem.style.display = 'block';
                    showNotification('Login successful! Welcome to Anchor Lab System');
                    
                    // Update queue controls based on current system state
                    updateQueueControls();
                } else {
                    showNotification('Invalid username or password. Please try again.', true);
                }
            });

            // Helper: validate patient info
            function validatePatientInfo() {
                const name = patientNameInput.value.trim();
                const age = patientAgeInput.value;
                const gender = patientGenderSelect.value;
                if (!name) {
                    showNotification('Please enter patient name before selecting a service.', true);
                    return false;
                }
                if (!age || isNaN(age) || Number(age) < 0) {
                    showNotification('Please enter a valid age before selecting a service.', true);
                    return false;
                }
                if (!gender) {
                    showNotification('Please select gender before selecting a service.', true);
                    return false;
                }
                return true;
            }

            // Service selection: requires patient info first
            serviceButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // ensure patient info entered first
                    if (!validatePatientInfo()) {
                        return;
                    }

                    // remove active classes
                    serviceButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    selectedService = this.getAttribute('data-service');
                    lastService = selectedService;

                    // Update ticket preview with service and patient
                    ticketService.textContent = selectedService;
                    const name = patientNameInput.value.trim();
                    const age = patientAgeInput.value.trim();
                    const gender = patientGenderSelect.value;
                    ticketPatient.textContent = `Patient: ${name} • ${age} yrs • ${gender}`;

                    // show the next ticket number (next to be issued)
                    ticketNumber.textContent = String(lastIssuedNumber + 1).padStart(3, '0');
                });
            });

            // Start queue
            startQueueBtn.addEventListener('click', function() {
                isQueueStarted = true;
                saveToFirebase();
                showNotification('Queue has been started! Patients can now be added.');
            });

            // Next patient (call) - UPDATED WITH ROOM ANNOUNCEMENTS
            nextBtn.addEventListener('click', function() {
                if (queue.length === 0) {
                    showNotification('No patients in the queue', true);
                    return;
                }

                const nextPatient = queue.shift();
                
                // Update patient status to 'Served' in allPatients
                const patientIndex = allPatients.findIndex(p => p.number === nextPatient.number);
                if (patientIndex !== -1) {
                    allPatients[patientIndex].status = 'Served';
                }

                // Save to Firebase (this will trigger real-time updates on all devices)
                saveToFirebase();

                showNotification('Now serving patient: ' + nextPatient.number);

                // Voice announcement with room number - UPDATED WITH ROOM
                const spokenNumber = parseInt(nextPatient.number, 10) || nextPatient.number;
                const room = serviceRooms[nextPatient.service] || "Room 1"; // Default to Room 1 if service not found
                announce(`Patient number ${spokenNumber}, ${nextPatient.service}, please proceed to ${room}. Thank you`);
            });

            // Add to queue when ticket preview clicked - UPDATED FOR ROLL PAPER PRINTING
            ticketPreview.addEventListener('click', function() {
                // ensure a service selected (or lastService exists)
                if (!selectedService && !lastService) {
                    showNotification('Please select a medical service first.', true);
                    return;
                }

                // ensure patient info present
                const name = patientNameInput.value.trim();
                const age = patientAgeInput.value.trim();
                const gender = patientGenderSelect.value;
                if (!name || !age || isNaN(age) || Number(age) < 0 || !gender) {
                    showNotification('Please fill valid patient Name, Age and Gender before adding.', true);
                    return;
                }

                if (!isQueueStarted) {
                    showNotification('Please start the queue first before adding patients.', true);
                    return;
                }

                // Number to assign is next after lastIssuedNumber
                const number = String(lastIssuedNumber + 1).padStart(3, '0');

                // Create patient object
                const patient = {
                    number: number,
                    service: selectedService || lastService,
                    name: name,
                    age: age,
                    gender: gender,
                    status: 'Waiting'
                };

                // Add to queue and allPatients (single source of truth)
                queue.push(patient);
                allPatients.push(patient);

                // Visual feedback for printing
                ticketPreview.classList.add('printing');
                
                // CREATE ROLL PAPER PRINTING WINDOW - UPDATED FOR QUEUE TICKETS
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Print Queue Ticket</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 3mm; 
                                font-family: 'Courier New', monospace;
                                width: 80mm;
                                font-size: 12px;
                                line-height: 1.2;
                            }
                            .ticket-header {
                                text-align: center;
                                margin-bottom: 5px;
                            }
                            .ticket-logo img {
                                max-width: 50px;
                                max-height: 50px;
                            }
                            .ticket-title {
                                font-size: 12px;
                                font-weight: bold;
                                line-height: 1.2;
                                margin-bottom: 5px;
                            }
                            h3 {
                                font-size: 11px;
                                margin: 3px 0;
                                text-align: center;
                                border-bottom: 1px dashed #000;
                                padding-bottom: 5px;
                            }
                            .ticket-number {
                                font-size: 42px;
                                font-weight: bold;
                                text-align: center;
                                margin: 15px 0;
                                color: #000;
                            }
                            .ticket-service {
                                font-size: 18px;
                                text-align: center;
                                margin-bottom: 5px;
                                font-weight: bold;
                            }
                            .ticket-patient {
                                font-size: 10px;
                                text-align: center;
                                margin-bottom: 5px;
                            }
                            .barcode-area {
                                margin: 10px 0;
                                text-align: center;
                                border-top: 1px dashed #000;
                                padding-top: 10px;
                            }
                            .barcode-placeholder {
                                height: 40px;
                                border: 1px solid #ccc;
                                margin: 5px auto;
                                width: 80%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 10px;
                                color: #666;
                            }
                            .ticket-footer {
                                font-size: 9px;
                                text-align: center;
                                margin-top: 10px;
                                border-top: 1px dashed #000;
                                padding-top: 8px;
                            }
                            hr {
                                border: none;
                                border-top: 1px dashed #000;
                                margin: 5px 0;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="ticket-header">
                            <div class="ticket-logo">
                                <img src="logo_anchor.png" alt="Logo" onerror="this.style.display='none'">
                            </div>
                            <div class="ticket-title">ANCHOR LAB & MEDICAL CENTER INC.</div>
                        </div>
                        <hr>
                        <h3>QUEUE TICKET</h3>
                        <div class="ticket-number">${number}</div>
                        <div class="ticket-service">${selectedService || lastService}</div>
                        <div class="ticket-patient">Patient: ${name}</div>
                        <div class="ticket-patient">Age: ${age} yrs | Gender: ${gender}</div>
                        <div class="barcode-area">
                            <div class="barcode-placeholder">BARCODE AREA</div>
                        </div>
                        <div class="ticket-footer">
                            Please wait for your number to be called<br>
                            ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                // Wait for content to load then print - UPDATED FOR ROLL PAPER
                setTimeout(() => {
                    printWindow.print();
                    // Don't close immediately to ensure print dialog is handled
                    setTimeout(() => {
                        printWindow.close();
                    }, 500);
                }, 250);

                setTimeout(() => { 
                    ticketPreview.classList.remove('printing'); 
                }, 1000);

                // Mark that we've issued this number
                lastIssuedNumber = lastIssuedNumber + 1;

                // Clear patient inputs so staff can add next patient
                patientNameInput.value = '';
                patientAgeInput.value = '';
                patientGenderSelect.value = '';

                // Save to Firebase (this will trigger real-time updates on all devices)
                saveToFirebase();

                showNotification('Ticket ' + number + ' added to ' + (selectedService || lastService) + ' queue');
            });

            // Update queue UI
            function updateQueueDisplay() {
                if (queue.length === 0) {
                    queueList.innerHTML = '<li class="queue-item">No patients in queue</li>';
                    return;
                }

                queueList.innerHTML = '';
                queue.forEach(patient => {
                    const li = document.createElement('li');
                    li.className = 'queue-item';
                    const left = document.createElement('div');
                    left.className = 'left';
                    const num = document.createElement('div');
                    num.className = 'queue-number';
                    num.textContent = patient.number;
                    const svc = document.createElement('div');
                    svc.className = 'queue-service';
                    svc.textContent = patient.service;
                    const pat = document.createElement('div');
                    pat.className = 'queue-patient';
                    pat.textContent = `${patient.name} • ${patient.age} yrs • ${patient.gender}`;
                    left.appendChild(num);
                    left.appendChild(svc);
                    left.appendChild(pat);

                    li.appendChild(left);
                    queueList.appendChild(li);
                });
            }

            // Show demographics
            demographicsBtn.addEventListener('click', function() {
                updateDemographicsTable();
                demographicsSection.style.display = 'block';
                backupSection.style.display = 'none';
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            });

            // Update demographics table
            function updateDemographicsTable() {
                demographicsTableBody.innerHTML = '';
                
                if (allPatients.length === 0) {
                    demographicsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No patient data available</td></tr>';
                    return;
                }
                
                allPatients.forEach(patient => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${patient.number}</td>
                        <td>${patient.name}</td>
                        <td>${patient.age}</td>
                        <td>${patient.gender}</td>
                        <td>${patient.service}</td>
                        <td>${patient.status}</td>
                    `;
                    demographicsTableBody.appendChild(row);
                });
            }

            // Print demographics
            printDemographicsBtn.addEventListener('click', function() {
                window.print();
            });

            // Download demographics data
            downloadDemographicsBtn.addEventListener('click', function() {
                const filename = `patient_demographics_${new Date().toISOString().split('T')[0]}.csv`;
                downloadCSV(allPatients, filename);
            });

            // Close demographics
            closeDemographicsBtn.addEventListener('click', function() {
                demographicsSection.style.display = 'none';
            });
            
            // Show backup section
            backupBtn.addEventListener('click', function() {
                backupSection.style.display = 'block';
                demographicsSection.style.display = 'none';
                updateBackupStats();
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            });
            
            // Save today's data to localStorage
            saveBackupBtn.addEventListener('click', function() {
                const today = new Date();
                const todayKey = formatDateForInput(today);
                const dataToSave = {
                    queue: queue,
                    allPatients: allPatients,
                    lastIssuedNumber: lastIssuedNumber,
                    isQueueStarted: isQueueStarted,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem(`queueData_${todayKey}`, JSON.stringify(dataToSave));
                updateBackupStats();
                showNotification(`Data saved for ${formatDateForDisplay(todayKey)}`);
                
                debugStoredData();
            });
            
            // Load data for selected date
            loadBackupBtn.addEventListener('click', function() {
                const selectedDate = backupDateInput.value;
                loadDataForDate(selectedDate);
                debugStoredData();
            });
            
            // Print backup data
            printBackupBtn.addEventListener('click', function() {
                window.print();
            });
            
            // Download backup data
            downloadBackupBtn.addEventListener('click', function() {
                const selectedDate = backupDateInput.value;
                const savedData = localStorage.getItem(`queueData_${selectedDate}`);
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.allPatients && data.allPatients.length > 0) {
                        const filename = `patient_backup_${selectedDate}.csv`;
                        downloadCSV(data.allPatients, filename);
                    } else {
                        showNotification('No data available for the selected date', true);
                    }
                } else {
                    showNotification('No data found for the selected date', true);
                }
            });
            
            // Close backup section
            closeBackupBtn.addEventListener('click', function() {
                backupSection.style.display = 'none';
            });
            
            // Debug button
            debugBtn.addEventListener('click', function() {
                debugStoredData();
            });

            // Logout
            logoutBtn.addEventListener('click', function() {
                // Reset system state locally
                isQueueStarted = false;
                selectedService = null;
                lastService = null;

                // Clear displays
                ticketNumber.textContent = '--';
                ticketService.textContent = 'Please select a service';
                ticketPatient.textContent = 'Patient: —';

                // Reset service buttons
                serviceButtons.forEach(btn => btn.classList.remove('active'));

                // Reset start queue button
                startQueueBtn.textContent = ' Start Queue';
                startQueueBtn.innerHTML = '<i class="fas fa-play-circle"></i> Start Queue';
                startQueueBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';

                // Clear login & patient fields
                usernameInput.value = '';
                passwordInput.value = '';
                patientNameInput.value = '';
                patientAgeInput.value = '';
                patientGenderSelect.value = '';

                // Show login, hide main system
                loginSection.style.display = 'block';
                document.querySelector('.content').style.display = 'flex';
                mainSystem.style.display = 'none';

                showNotification('Logged out successfully');
            });

            // Initialize UI
            ticketNumber.textContent = '--';
            ticketService.textContent = 'Please select a service';
            ticketPatient.textContent = 'Patient: —';
            queueList.innerHTML = '<li class="queue-item">No patients in queue</li>';
            updateBackupStats();
            
            // FIX: Initialize public display
            updatePublicDisplay();
        });
    </script>
</body>
</html>